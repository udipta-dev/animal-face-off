<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Animal Faceoff ‚Äî Who Would Win?</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶Å</text></svg>" />
  <!-- Open Graph / Social sharing -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://udipta-dev.github.io/animal-face-off/" />
  <meta property="og:title" content="Animal Faceoff ‚Äî Who Would Win?" />
  <meta property="og:description" content="Predict the winner of epic animal battles! 40 animals, 2 weight classes, trump cards. Play the tournament and climb the global leaderboard." />
  <meta property="og:image" content="https://udipta-dev.github.io/animal-face-off/images/og-banner.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Animal Faceoff ‚Äî Who Would Win?" />
  <meta name="twitter:description" content="Predict the winner of epic animal battles! 40 animals, 2 weight classes, trump cards!" />
  <meta name="twitter:image" content="https://udipta-dev.github.io/animal-face-off/images/og-banner.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a1a;
      color: white;
      overflow-x: hidden;
      min-height: 100vh;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    @keyframes slideInLeft {
      from { transform: translateX(-120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes lightningFlash {
      0% { opacity: 0; transform: scale(0.5); }
      30% { opacity: 1; transform: scale(1.2); }
      60% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.1); }
    }
    @keyframes pulseWin {
      0% { transform: scale(1); }
      50% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }
    @keyframes statBarGrow { from { width: 0%; } }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes vsPopIn {
      0% { transform: scale(0) rotate(-30deg); opacity: 0; }
      60% { transform: scale(1.3) rotate(5deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(255,165,0,0.3); }
      50% { box-shadow: 0 0 40px rgba(255,165,0,0.6); }
    }
    @keyframes streakFire {
      0%, 100% { text-shadow: 0 0 10px #ff6600, 0 0 20px #ff3300; }
      50% { text-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300, 0 0 60px #ff0000; }
    }
    .slide-in-left { animation: slideInLeft 0.5s ease-out forwards; }
    .slide-in-right { animation: slideInRight 0.5s ease-out forwards; }
    .lightning-flash { animation: lightningFlash 0.4s ease-out forwards; }
    .pulse-win { animation: pulseWin 0.6s ease-in-out infinite; }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
    .vs-pop { animation: vsPopIn 0.6s ease-out forwards; animation-delay: 0.3s; opacity: 0; }
    .glow-pulse { animation: glowPulse 2s ease-in-out infinite; }
    .streak-fire { animation: streakFire 1s ease-in-out infinite; }
    .stat-bar-animate { animation: statBarGrow 0.8s ease-out forwards; }
    .stat-bar-delay-1 { animation-delay: 0.1s; }
    .stat-bar-delay-2 { animation-delay: 0.2s; }
    .stat-bar-delay-3 { animation-delay: 0.3s; }
    .stat-bar-delay-4 { animation-delay: 0.4s; }
    @keyframes trumpFlash {
      0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
      40% { opacity: 1; transform: scale(1.15) rotate(2deg); }
      70% { transform: scale(0.95) rotate(-1deg); }
      100% { opacity: 1; transform: scale(1) rotate(0deg); }
    }
    .trump-flash { animation: trumpFlash 0.6s ease-out forwards; }
    .animal-card {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }
    .line-clamp-4 {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .fact-box { height: 4.2rem; }
    @media (min-width: 640px) { .fact-box { height: 3rem; } }
    .animal-card:active { transform: scale(0.96); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    var e = React.createElement;
    var useState = React.useState, useEffect = React.useEffect, useCallback = React.useCallback, useRef = React.useRef;

    // ==================== CONFIG ====================
    var TOURNAMENT_ROUNDS = 10;

    // ==================== SUPABASE ====================
    var SUPABASE_URL = 'https://mteintczrnpylwxnohvw.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10ZWludGN6cm5weWx3eG5vaHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjg4NjQsImV4cCI6MjA4NjgwNDg2NH0.V0oRv6nvfnPB1fC7tAh9rcwgA5m28iIXj9DjVGUdEu0';
    var sb = null;
    try {
      if (window.supabase && window.supabase.createClient && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch(ex) { console.warn('Supabase init failed:', ex); }

    // Division column mapping ‚Äî add new divisions here
    var DIV_COLS = {
      heavyweight: { score: "best_hw_score", streak: "best_hw_streak", correct: "best_hw_correct" },
      middleweight: { score: "best_mw_score", streak: "best_mw_streak", correct: "best_mw_correct" },
      dinosaurs: { score: "best_dino_score", streak: "best_dino_streak", correct: "best_dino_correct" }
    };
    var ALL_DIV_SCORE_COLS = Object.keys(DIV_COLS).map(function(k) { return DIV_COLS[k].score; });
    var ALL_DIV_COLS = [];
    Object.keys(DIV_COLS).forEach(function(k) {
      var c = DIV_COLS[k];
      ALL_DIV_COLS.push(c.score, c.streak, c.correct);
    });

    function submitScoreToSupabase(playerName, divisionKey, runScore, runStreak, runCorrect) {
      if (!sb) return Promise.resolve(null);
      var cols = DIV_COLS[divisionKey];
      if (!cols) return Promise.resolve(null);
      var selectCols = ['id'].concat(ALL_DIV_COLS).join(', ');
      return sb.from('leaderboard').select(selectCols)
        .eq('player_name', playerName).limit(1)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) {
            var row = { player_name: playerName, streak: runStreak, rounds_correct: runCorrect };
            ALL_DIV_COLS.forEach(function(c) { row[c] = 0; });
            row[cols.score] = runScore;
            row[cols.streak] = runStreak;
            row[cols.correct] = runCorrect;
            row.score = runScore;
            return sb.from('leaderboard').insert([row]);
          }
          var existing = r.data[0];
          var oldDivScore = existing[cols.score] || 0;
          if (runScore > oldDivScore) {
            var upd = {};
            upd[cols.score] = runScore;
            upd[cols.streak] = runStreak;
            upd[cols.correct] = runCorrect;
            var combined = 0;
            ALL_DIV_SCORE_COLS.forEach(function(sc) {
              combined += (sc === cols.score) ? runScore : (existing[sc] || 0);
            });
            upd.score = combined;
            upd.created_at = new Date().toISOString();
            return sb.from('leaderboard').update(upd).eq('id', existing.id);
          }
          return Promise.resolve({ data: null, error: null });
        })
        .then(function(r) { if (r && r.error) console.warn('Supabase upsert error:', r.error.message); return r; })
        .catch(function(err) { console.warn('Supabase submit failed:', err); return null; });
    }

    function fetchPlayerProfile(playerName) {
      if (!sb || !playerName) return Promise.resolve(null);
      var selectCols = ALL_DIV_COLS.concat(['score']).join(', ');
      return sb.from('leaderboard').select(selectCols)
        .eq('player_name', playerName).limit(1)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) return null;
          return r.data[0];
        })
        .catch(function() { return null; });
    }

    function fetchGlobalLeaderboard(playerName) {
      if (!sb) return Promise.resolve(null);
      // score column = best_hw_score + best_mw_score (updated on submit)
      var topPromise = sb.from('leaderboard').select('player_name, score, best_hw_score, best_mw_score')
        .order('score', { ascending: false }).order('created_at', { ascending: true }).limit(10)
        .then(function(r) {
          if (r.error) { console.warn('Supabase fetch error:', r.error.message); return []; }
          return r.data || [];
        });
      var playerPromise = playerName ? sb.from('leaderboard').select('player_name, score, best_hw_score, best_mw_score')
        .eq('player_name', playerName).limit(1)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) return null;
          return r.data[0];
        }) : Promise.resolve(null);
      var playerRankPromise = playerName ? sb.from('leaderboard').select('player_name, score')
        .eq('player_name', playerName).limit(1)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) return null;
          var playerScore = r.data[0].score;
          return sb.from('leaderboard').select('id', { count: 'exact', head: true })
            .gt('score', playerScore)
            .then(function(r2) {
              if (r2.error) return null;
              return (r2.count || 0) + 1;
            });
        }) : Promise.resolve(null);

      return Promise.all([topPromise, playerPromise, playerRankPromise])
        .then(function(results) {
          return { top: results[0], player: results[1], playerRank: results[2] };
        })
        .catch(function(err) { console.warn('Supabase fetch failed:', err); return null; });
    }

    // ==================== ANIMAL DATABASE ====================
    var WEIGHT_CLASSES = {
      heavyweight: { label: "Heavyweight", emoji: "\uD83C\uDFCB\uFE0F", desc: "The biggest, baddest animals on the planet" },
      middleweight: { label: "Middleweight", emoji: "\uD83D\uDC3A", desc: "Fast, fierce, and deadly mid-size predators" },
      dinosaurs: { label: "Dinosaurs", emoji: "\uD83E\uDD96", desc: "Prehistoric giants and ferocious killers" }
    };

    var allAnimals = [
      // ---- HEAVYWEIGHT ----
      { id: "lion_001", name: "Lion", emoji: "\uD83E\uDD81", imageBase: "lion", weightClass: "heavyweight",
        stats: { strength: 85, speed: 75, defense: 70, aggression: 90 },
        trump: { name: "Pack Hunter", bonus: 15, desc: "Calls the pride" },
        facts: ["Lives in prides of up to 30 \u2014 the only social big cat", "A lion's roar can be heard from 5 miles away", "Female lions do 90% of the hunting"] },
      { id: "tiger_001", name: "Tiger", emoji: "\uD83D\uDC2F", imageBase: "tiger", weightClass: "heavyweight",
        stats: { strength: 90, speed: 80, defense: 65, aggression: 85 },
        trump: { name: "Ambush Strike", bonus: 18, desc: "Strikes from the shadows" },
        facts: ["Can eat 90 lbs of meat in one sitting", "No two tigers have the same stripe pattern", "Can swim for miles \u2014 one of the few cats that loves water"] },
      { id: "grizzly_001", name: "Grizzly Bear", emoji: "\uD83D\uDC3B", imageBase: "grizzly-bear", weightClass: "heavyweight",
        stats: { strength: 95, speed: 60, defense: 85, aggression: 80 },
        trump: { name: "Bear Rage", bonus: 17, desc: "Goes full berserker" },
        facts: ["Can smell food from 18 miles away", "Runs up to 35 mph \u2014 faster than a horse in short bursts", "Eats up to 90 lbs of food per day before hibernation"] },
      { id: "polar_001", name: "Polar Bear", emoji: "\u2744\uFE0F", imageBase: "polar-bear", weightClass: "heavyweight",
        stats: { strength: 95, speed: 58, defense: 90, aggression: 82 },
        trump: { name: "Arctic Fury", bonus: 18, desc: "Unleashes cold-blooded rage" },
        facts: ["Largest land carnivore \u2014 weighs up to 1,500 lbs", "Skin is actually black under the white fur", "Can swim non-stop for over 60 miles"] },
      { id: "gorilla_001", name: "Gorilla", emoji: "\uD83E\uDD8D", imageBase: "gorilla", weightClass: "heavyweight",
        stats: { strength: 100, speed: 55, defense: 75, aggression: 75 },
        trump: { name: "Chest Pound", bonus: 13, desc: "Intimidation overload" },
        facts: ["10x stronger than an adult human", "Shares 98% of its DNA with humans", "Each gorilla has a unique nose print, like a fingerprint"] },
      { id: "croc_001", name: "Crocodile", emoji: "\uD83D\uDC0A", imageBase: "crocodile", weightClass: "heavyweight",
        stats: { strength: 93, speed: 45, defense: 92, aggression: 90 },
        trump: { name: "Death Roll", bonus: 18, desc: "Signature killing move" },
        facts: ["Unchanged for 200 million years \u2014 older than dinosaurs", "Can hold its breath underwater for over an hour", "Has the strongest bite ever measured in a living animal"] },
      { id: "moose_001", name: "Moose", emoji: "\uD83E\uDD8C", imageBase: "moose", weightClass: "heavyweight",
        stats: { strength: 82, speed: 65, defense: 68, aggression: 72 },
        trump: { name: "Antler Smash", bonus: 14, desc: "Swings massive rack" },
        facts: ["Antlers can span 6 feet and weigh 80 lbs", "Can dive 20 feet underwater to eat aquatic plants", "Newborn calves can outrun a human within 5 days"] },
      { id: "anaconda_001", name: "Anaconda", emoji: "\uD83D\uDC0D", imageBase: "anaconda", weightClass: "heavyweight",
        stats: { strength: 88, speed: 54, defense: 78, aggression: 80 },
        trump: { name: "Constrict", bonus: 16, desc: "Squeezes the life out" },
        facts: ["Can swallow prey larger than its own head", "Weighs over 500 lbs \u2014 heaviest snake on Earth", "Gives birth to live babies, not eggs"] },
      { id: "black_bear_001", name: "Black Bear", emoji: "\uD83D\uDC3B", imageBase: "black-bear", weightClass: "heavyweight",
        stats: { strength: 78, speed: 65, defense: 72, aggression: 68 },
        trump: { name: "Tree Ambush", bonus: 13, desc: "Attacks from above" },
        facts: ["Excellent tree climber despite weighing 600 lbs", "Heart rate drops to 8 beats per minute during hibernation", "Can run 30 mph \u2014 faster than most humans can bike"] },
      { id: "gaur_001", name: "Gaur", emoji: "\uD83D\uDC02", imageBase: "gaur", weightClass: "heavyweight",
        stats: { strength: 92, speed: 58, defense: 70, aggression: 88 },
        trump: { name: "Iron Horns", bonus: 15, desc: "Gores with massive horns" },
        facts: ["Largest wild cattle \u2014 stands 7 feet at the shoulder", "Herds are led by the oldest female, not the strongest male", "Can jump a 6-foot fence from a standstill"] },
      { id: "bison_001", name: "American Bison", emoji: "\uD83E\uDDAC", imageBase: "american-bison", weightClass: "heavyweight",
        stats: { strength: 90, speed: 58, defense: 80, aggression: 78 },
        trump: { name: "Bulldoze", bonus: 14, desc: "2000lbs of momentum" },
        facts: ["Can run 35 mph despite weighing 2,000 lbs", "Nearly went extinct \u2014 dropped from 60 million to just 541", "Babies are born orange and turn brown after a few months"] },
      { id: "jaguar_001", name: "Jaguar", emoji: "\uD83D\uDC06", imageBase: "jaguar", weightClass: "heavyweight",
        stats: { strength: 82, speed: 82, defense: 60, aggression: 88 },
        trump: { name: "Skull Crusher", bonus: 17, desc: "Bites through bone" },
        facts: ["Bite can crack a turtle shell and pierce skulls", "The only big cat in the Americas", "Loves swimming and hunts caimans in rivers"] },
      { id: "cape_buffalo_001", name: "Cape Buffalo", emoji: "\uD83D\uDC03", imageBase: "cape-buffalo", weightClass: "heavyweight",
        stats: { strength: 85, speed: 55, defense: 78, aggression: 92 },
        trump: { name: "Stampede", bonus: 16, desc: "Charges with full force" },
        facts: ["Nicknamed \"Black Death\" \u2014 kills more hunters than any big cat", "Has incredible memory and will ambush past attackers", "Herds vote on travel direction by standing and staring"] },
      { id: "komodo_001", name: "Komodo Dragon", emoji: "\uD83E\uDD8E", imageBase: "komodo-dragon", weightClass: "heavyweight",
        stats: { strength: 72, speed: 55, defense: 82, aggression: 90 },
        trump: { name: "Venom Bite", bonus: 17, desc: "Toxic saliva kicks in" },
        facts: ["Venomous bite causes prey to bleed out in hours", "Can eat 80% of its body weight in a single meal", "Has been clocked running 12 mph in short bursts"] },
      { id: "cassowary_001", name: "Cassowary", emoji: "\uD83D\uDC26", imageBase: "cassowary", weightClass: "heavyweight",
        stats: { strength: 62, speed: 75, defense: 52, aggression: 91 },
        trump: { name: "Dagger Kick", bonus: 15, desc: "Razor claw slash" },
        facts: ["Most dangerous bird \u2014 has a dagger-like 5-inch claw", "Can run 31 mph through dense rainforest", "Dad raises the chicks alone for 9 months"] },
      { id: "wildebeest_001", name: "Wildebeest", emoji: "\uD83D\uDC03", imageBase: "wildebeest", weightClass: "heavyweight",
        stats: { strength: 75, speed: 72, defense: 60, aggression: 70 },
        trump: { name: "Herd Rush", bonus: 12, desc: "Strength in numbers" },
        facts: ["Migrates 1,000 miles every year in herds of millions", "Calves can walk within minutes of being born", "Over 250,000 die during migration each year"] },
      { id: "kangaroo_001", name: "Kangaroo", emoji: "\uD83E\uDD98", imageBase: "kangaroo", weightClass: "heavyweight",
        stats: { strength: 70, speed: 75, defense: 58, aggression: 82 },
        trump: { name: "Power Kick", bonus: 13, desc: "Devastating drop kick" },
        facts: ["Can leap 30 feet in a single bound", "Uses its tail like a fifth leg for balance and fighting", "Cannot walk backwards"] },
      { id: "chimpanzee_001", name: "Chimpanzee", emoji: "\uD83D\uDC12", imageBase: "chimpanzee", weightClass: "heavyweight",
        stats: { strength: 78, speed: 68, defense: 60, aggression: 95 },
        trump: { name: "Troop Frenzy", bonus: 16, desc: "Calls in a vicious mob" },
        facts: ["Shares 98.7% of DNA with humans", "Uses tools like sticks to fish for termites", "Can learn and use sign language"] },
      { id: "walrus_001", name: "Walrus", emoji: "\uD83E\uDDAD", imageBase: "walrus", weightClass: "heavyweight",
        stats: { strength: 85, speed: 35, defense: 90, aggression: 65 },
        trump: { name: "Tusk Charge", bonus: 14, desc: "3000lbs behind tusks" },
        facts: ["Tusks grow up to 3 feet long and weigh 12 lbs each", "Can slow its heartbeat to survive freezing water", "Sleeps up to 19 hours a day on land"] },
      { id: "ostrich_001", name: "Ostrich", emoji: "\uD83D\uDC26", imageBase: "ostrich", weightClass: "heavyweight",
        stats: { strength: 60, speed: 90, defense: 50, aggression: 68 },
        trump: { name: "Turbo Sprint", bonus: 12, desc: "Fastest legs alive" },
        facts: ["Fastest bird on land \u2014 runs 45 mph", "Eyes are bigger than its brain", "One egg equals about 24 chicken eggs"] },

      // ---- MIDDLEWEIGHT ----
      { id: "cougar_001", name: "Cougar", emoji: "\uD83D\uDC06", imageBase: "cougar", weightClass: "middleweight",
        stats: { strength: 78, speed: 82, defense: 62, aggression: 85 },
        trump: { name: "Silent Pounce", bonus: 17, desc: "Leaps from nowhere" },
        facts: ["Can leap 40 feet horizontally from a standstill", "Has the largest range of any wild land mammal in the Americas", "Cannot roar \u2014 purrs like a house cat"] },
      { id: "snow_leopard_001", name: "Snow Leopard", emoji: "\uD83D\uDC06", imageBase: "snow-leopard", weightClass: "middleweight",
        stats: { strength: 75, speed: 85, defense: 60, aggression: 85 },
        trump: { name: "Ghost Strike", bonus: 17, desc: "Phantom of the mountains" },
        facts: ["Can jump 50 feet \u2014 6x its own body length", "Tail is almost as long as its body, used for balance", "So rare it's called the \"ghost of the mountains\""] },
      { id: "grey_wolf_001", name: "Grey Wolf", emoji: "\uD83D\uDC3A", imageBase: "grey-wolf", weightClass: "middleweight",
        stats: { strength: 72, speed: 78, defense: 65, aggression: 88 },
        trump: { name: "Pack Call", bonus: 16, desc: "The pack arrives" },
        facts: ["Pack can take down prey 10x their size", "Can travel 30 miles in a single day while hunting", "Mates for life and both parents raise the pups"] },
      { id: "wolverine_001", name: "Wolverine", emoji: "\uD83E\uDDA1", imageBase: "wolverine", weightClass: "middleweight",
        stats: { strength: 72, speed: 65, defense: 70, aggression: 95 },
        trump: { name: "Berserker", bonus: 18, desc: "Fights anything, fears nothing" },
        facts: ["Known to fight bears and wolves over food", "Can smell prey buried 20 feet under snow", "Travels up to 15 miles a day without stopping"] },
      { id: "spotted_hyena_001", name: "Spotted Hyena", emoji: "\uD83D\uDC3A", imageBase: "spotted-hyena", weightClass: "middleweight",
        stats: { strength: 78, speed: 70, defense: 68, aggression: 85 },
        trump: { name: "Bone Crusher", bonus: 16, desc: "Jaws snap through bone" },
        facts: ["Bite force of 1,100 PSI \u2014 crushes bone to eat marrow", "Lives in clans of up to 80 led by females", "Can digest bones, horns, and even teeth"] },
      { id: "wild_boar_001", name: "Wild Boar", emoji: "\uD83D\uDC17", imageBase: "wild-boar", weightClass: "middleweight",
        stats: { strength: 68, speed: 58, defense: 75, aggression: 92 },
        trump: { name: "Tusk Gore", bonus: 15, desc: "Charges tusks-first" },
        facts: ["Has been hunted by humans for over 10,000 years", "Can run 30 mph and swim across rivers", "Tusks sharpen themselves every time the mouth opens"] },
      { id: "african_wild_dog_001", name: "African Wild Dog", emoji: "\uD83D\uDC15", imageBase: "african-wild-dog", weightClass: "middleweight",
        stats: { strength: 58, speed: 82, defense: 50, aggression: 90 },
        trump: { name: "Relay Hunt", bonus: 15, desc: "Takes turns chasing prey down" },
        facts: ["80% hunt success rate \u2014 highest of any predator", "Every pack member helps feed the sick and injured", "Pups eat first, even before the alphas"] },
      { id: "warthog_001", name: "Warthog", emoji: "\uD83D\uDC17", imageBase: "warthog", weightClass: "middleweight",
        stats: { strength: 62, speed: 65, defense: 72, aggression: 80 },
        trump: { name: "Burrow Charge", bonus: 13, desc: "Explosive burst from cover" },
        facts: ["Runs into burrows backwards to defend with tusks", "Can survive weeks without water in the dry season", "Lets birds ride on its back to eat ticks and parasites"] },
      { id: "cheetah_001", name: "Cheetah", emoji: "\uD83D\uDC06", imageBase: "cheetah", weightClass: "middleweight",
        stats: { strength: 55, speed: 100, defense: 42, aggression: 80 },
        trump: { name: "Top Speed", bonus: 16, desc: "Hits 70mph" },
        facts: ["Hits 70 mph in 3 seconds \u2014 faster than a sports car", "Cannot roar \u2014 chirps and purrs instead", "Each hunt lasts less than 60 seconds"] },
      { id: "red_kangaroo_001", name: "Red Kangaroo", emoji: "\uD83E\uDD98", imageBase: "red-kangaroo", weightClass: "middleweight",
        stats: { strength: 70, speed: 72, defense: 58, aggression: 75 },
        trump: { name: "Boxing Combo", bonus: 14, desc: "Rapid-fire punches" },
        facts: ["Can kick with 760 lbs of force", "Males flex their biceps to impress females", "Joey lives in the pouch for 8 months after birth"] },
      { id: "clouded_leopard_001", name: "Clouded Leopard", emoji: "\uD83D\uDC06", imageBase: "clouded-leopard", weightClass: "middleweight",
        stats: { strength: 62, speed: 78, defense: 52, aggression: 82 },
        trump: { name: "Canine Strike", bonus: 14, desc: "Longest fangs for its size" },
        facts: ["Longest canine teeth relative to body size of any cat", "Can hang upside down from branches by its back feet", "Can climb down trees headfirst like a squirrel"] },
      { id: "baboon_001", name: "Baboon", emoji: "\uD83D\uDC12", imageBase: "baboon", weightClass: "middleweight",
        stats: { strength: 60, speed: 70, defense: 55, aggression: 88 },
        trump: { name: "Troop Frenzy", bonus: 15, desc: "Calls in the whole troop" },
        facts: ["Troops of 100+ with complex social hierarchies", "Can run 30 mph to escape predators", "Grooms each other to build alliances and friendships"] },
      { id: "caiman_001", name: "Caiman", emoji: "\uD83D\uDC0A", imageBase: "caiman", weightClass: "middleweight",
        stats: { strength: 72, speed: 42, defense: 80, aggression: 78 },
        trump: { name: "Snap Lock", bonus: 14, desc: "Jaws clamp shut" },
        facts: ["Can stay underwater without moving for over an hour", "Eyes and nostrils sit on top of its head for stealth", "Stomach acid is strong enough to dissolve bone"] },
      { id: "king_cobra_001", name: "King Cobra", emoji: "\uD83D\uDC0D", imageBase: "king-cobra", weightClass: "middleweight",
        stats: { strength: 48, speed: 88, defense: 42, aggression: 90 },
        trump: { name: "Venom Strike", bonus: 18, desc: "One bite, lights out" },
        facts: ["One bite has enough venom to kill an elephant", "Can raise a third of its body upright \u2014 eye level with humans", "Only snake that builds a nest for its eggs"] },
      { id: "dhole_001", name: "Dhole", emoji: "\uD83D\uDC15", imageBase: "dhole", weightClass: "middleweight",
        stats: { strength: 55, speed: 78, defense: 50, aggression: 85 },
        trump: { name: "Swarm Attack", bonus: 15, desc: "Attacks in a pack" },
        facts: ["Whistles to communicate during hunts", "Can take down prey 10x its size as a pack", "One of the few wild dogs that feeds pups by regurgitation"] },
      { id: "tasmanian_devil_001", name: "Tasmanian Devil", emoji: "\uD83D\uDE08", imageBase: "tasmanian-devil", weightClass: "middleweight",
        stats: { strength: 55, speed: 60, defense: 58, aggression: 95 },
        trump: { name: "Devil Scream", bonus: 16, desc: "Blood-curdling screech + bite" },
        facts: ["Strongest bite relative to body size of any mammal", "Stores fat in its tail when well-fed", "Screams so loud it scared early European settlers"] },
      { id: "giant_anteater_001", name: "Giant Anteater", emoji: "\uD83D\uDC3E", imageBase: "giant-anteater", weightClass: "middleweight",
        stats: { strength: 65, speed: 55, defense: 70, aggression: 72 },
        trump: { name: "Claw Slash", bonus: 14, desc: "4-inch razor claws" },
        facts: ["Tongue flicks 150 times per minute to eat 35,000 ants a day", "Has no teeth \u2014 grinds food with hard bumps in its mouth", "Claws are strong enough to rip open concrete-hard termite mounds"] },
      { id: "ocelot_001", name: "Ocelot", emoji: "\uD83D\uDC31", imageBase: "ocelot", weightClass: "middleweight",
        stats: { strength: 55, speed: 82, defense: 48, aggression: 76 },
        trump: { name: "Night Ambush", bonus: 13, desc: "Strikes in darkness" },
        facts: ["Has night vision 6x better than humans", "Was nearly hunted to extinction for its fur", "Each ocelot's coat pattern is completely unique"] },
      { id: "coyote_001", name: "Coyote", emoji: "\uD83D\uDC3A", imageBase: "coyote", weightClass: "middleweight",
        stats: { strength: 52, speed: 80, defense: 48, aggression: 78 },
        trump: { name: "Scavenger Trick", bonus: 13, desc: "Outsmart and outlast" },
        facts: ["Has expanded its range despite centuries of hunting", "Can run 40 mph and swim long distances", "Pairs sometimes team up with badgers to hunt together"] },
      { id: "emu_001", name: "Emu", emoji: "\uD83D\uDC26", imageBase: "emu", weightClass: "middleweight",
        stats: { strength: 50, speed: 85, defense: 45, aggression: 75 },
        trump: { name: "War Charge", bonus: 12, desc: "Won a war against Australia" },
        facts: ["Won the Great Emu War of 1932 against the Australian army", "Can go weeks without eating", "Has two sets of eyelids \u2014 one for blinking, one for dust"] },

      // ---- DINOSAURS ----
      { id: "trex_001", name: "T-Rex", emoji: "\uD83E\uDD96", imageBase: "t-rex", weightClass: "dinosaurs",
        stats: { strength: 95, speed: 58, defense: 78, aggression: 94 },
        trump: { name: "Bone Crusher Bite", bonus: 18, desc: "12,800 lbs of bite force" },
        facts: ["Bite force of 12,800 lbs \u2014 could crush bone like paper", "Could eat 500 lbs of meat in a single bite", "Lived only in North America 68 million years ago"] },
      { id: "spinosaurus_001", name: "Spinosaurus", emoji: "\uD83E\uDD95", imageBase: "spinosaurus", weightClass: "dinosaurs",
        stats: { strength: 90, speed: 65, defense: 82, aggression: 88 },
        trump: { name: "Aquatic Ambush", bonus: 18, desc: "Drags prey underwater" },
        facts: ["Largest carnivorous dinosaur \u2014 even bigger than T-Rex", "Spent most of its time in water like a giant croc", "Had a 6-foot sail on its back for display or temperature control"] },
      { id: "giganotosaurus_001", name: "Giganotosaurus", emoji: "\uD83E\uDD96", imageBase: "giganotosaurus", weightClass: "dinosaurs",
        stats: { strength: 92, speed: 62, defense: 72, aggression: 90 },
        trump: { name: "Slashing Charge", bonus: 17, desc: "Razor teeth at full sprint" },
        facts: ["Brain was shaped like a banana and half the size of T-Rex's", "Lived 30 million years before T-Rex \u2014 they never met", "Could weigh up to 8 tons \u2014 heavier than an elephant"] },
      { id: "triceratops_001", name: "Triceratops", emoji: "\uD83E\uDD8F", imageBase: "triceratops", weightClass: "dinosaurs",
        stats: { strength: 90, speed: 48, defense: 92, aggression: 85 },
        trump: { name: "Triple Horn Charge", bonus: 18, desc: "Three horns, one target" },
        facts: ["Frill was made of solid bone \u2014 like a built-in shield", "Had up to 800 teeth stacked in columns for grinding plants", "One of the last dinosaurs alive before the asteroid hit"] },
      { id: "mosasaurus_001", name: "Mosasaurus", emoji: "\uD83D\uDC0B", imageBase: "mosasaurus", weightClass: "dinosaurs",
        stats: { strength: 88, speed: 70, defense: 75, aggression: 85 },
        trump: { name: "Ocean Terror", bonus: 17, desc: "Apex predator of the deep" },
        facts: ["Ruled the oceans and could grow over 50 feet long", "Had a double-hinged jaw to swallow prey whole", "Not actually a dinosaur \u2014 it's a giant marine lizard"] },
      { id: "sarcosuchus_001", name: "Sarcosuchus", emoji: "\uD83D\uDC0A", imageBase: "sarcosuchus", weightClass: "dinosaurs",
        stats: { strength: 92, speed: 40, defense: 90, aggression: 85 },
        trump: { name: "Super Croc Death Roll", bonus: 18, desc: "40-foot croc locks on" },
        facts: ["A 40-foot crocodile that weighed as much as an elephant", "Jaws were 6 feet long with over 100 teeth", "Lived in rivers alongside dinosaurs 112 million years ago"] },
      { id: "allosaurus_001", name: "Allosaurus", emoji: "\uD83E\uDD96", imageBase: "allosaurus", weightClass: "dinosaurs",
        stats: { strength: 82, speed: 75, defense: 65, aggression: 85 },
        trump: { name: "Pack Assault", bonus: 16, desc: "Hunts in coordinated groups" },
        facts: ["Had arms strong enough to hold prey while biting", "Most common predator of the Jurassic period", "Fossils show they sometimes hunted in groups"] },
      { id: "carnotaurus_001", name: "Carnotaurus", emoji: "\uD83E\uDD96", imageBase: "carnotaurus", weightClass: "dinosaurs",
        stats: { strength: 75, speed: 82, defense: 60, aggression: 88 },
        trump: { name: "Bull Rush", bonus: 15, desc: "Fastest large theropod" },
        facts: ["Fastest large meat-eater \u2014 built like a bull", "Had tiny arms even smaller than T-Rex's", "Name means \"meat-eating bull\" because of its horns"] },
      { id: "utahraptor_001", name: "Utahraptor", emoji: "\uD83E\uDD96", imageBase: "utahraptor", weightClass: "dinosaurs",
        stats: { strength: 72, speed: 85, defense: 55, aggression: 88 },
        trump: { name: "Killing Claw", bonus: 17, desc: "9-inch sickle claw strike" },
        facts: ["Sickle claw was 9 inches long \u2014 like a curved dagger", "Weighed over 1,000 lbs \u2014 far bigger than a Velociraptor", "Discovered in Utah in 1993, same year as Jurassic Park"] },
      { id: "deinonychus_001", name: "Deinonychus", emoji: "\uD83E\uDD96", imageBase: "deinonychus", weightClass: "dinosaurs",
        stats: { strength: 65, speed: 88, defense: 50, aggression: 85 },
        trump: { name: "Leaping Strike", bonus: 15, desc: "Pounces from above" },
        facts: ["Discovered in groups \u2014 proof that raptors hunted in packs", "The dinosaur that inspired Jurassic Park's \"Velociraptors\"", "Could leap onto prey and slash with its toe claws"] },
      { id: "velociraptor_001", name: "Velociraptor", emoji: "\uD83E\uDD96", imageBase: "velociraptor", weightClass: "dinosaurs",
        stats: { strength: 55, speed: 92, defense: 45, aggression: 90 },
        trump: { name: "Pack Intelligence", bonus: 16, desc: "Outsmarts its prey" },
        facts: ["Turkey-sized in real life \u2014 not like the movies", "Had feathers covering its body like a bird", "Lived in the deserts of Mongolia, not tropical jungles"] },
      { id: "dilophosaurus_001", name: "Dilophosaurus", emoji: "\uD83E\uDD96", imageBase: "dilophosaurus", weightClass: "dinosaurs",
        stats: { strength: 68, speed: 78, defense: 55, aggression: 80 },
        trump: { name: "Crest Display", bonus: 14, desc: "Distracts then strikes" },
        facts: ["Had twin crests on its head \u2014 no venom despite the movie", "One of the earliest large predatory dinosaurs", "Was actually 20 feet long \u2014 way bigger than shown in film"] },
      { id: "pachycephalosaurus_001", name: "Pachycephalosaurus", emoji: "\uD83E\uDD95", imageBase: "pachycephalosaurus", weightClass: "dinosaurs",
        stats: { strength: 65, speed: 70, defense: 75, aggression: 78 },
        trump: { name: "Skull Ram", bonus: 16, desc: "10-inch thick dome headbutt" },
        facts: ["Skull dome was 10 inches of solid bone", "May have head-butted rivals like modern bighorn sheep", "Lived right at the end of the dinosaur age, 66 million years ago"] },
      { id: "ankylosaurus_001", name: "Ankylosaurus", emoji: "\uD83E\uDD95", imageBase: "ankylosaurus", weightClass: "dinosaurs",
        stats: { strength: 82, speed: 35, defense: 98, aggression: 65 },
        trump: { name: "Tail Club Smash", bonus: 22, desc: "Bone-shattering club swing" },
        facts: ["Tail club could shatter a T-Rex's leg bones", "Even its eyelids were armored with bone", "Weighed 8 tons \u2014 like a living tank"] },
      { id: "stegosaurus_001", name: "Stegosaurus", emoji: "\uD83E\uDD95", imageBase: "stegosaurus", weightClass: "dinosaurs",
        stats: { strength: 78, speed: 40, defense: 88, aggression: 68 },
        trump: { name: "Thagomizer", bonus: 20, desc: "Spiked tail whip" },
        facts: ["Brain was the size of a walnut despite being bus-sized", "Back plates may have flushed red to scare predators", "Lived 80 million years before T-Rex \u2014 farther apart than T-Rex and us"] },
      { id: "brachiosaurus_001", name: "Brachiosaurus", emoji: "\uD83E\uDD95", imageBase: "brachiosaurus", weightClass: "dinosaurs",
        stats: { strength: 98, speed: 30, defense: 92, aggression: 50 },
        trump: { name: "Titan Stomp", bonus: 22, desc: "80 tons comes crashing down" },
        facts: ["Weighed 80 tons \u2014 heart pumped blood 30 feet up to its head", "Ate 900 lbs of plants every single day", "Nostrils were on top of its head like a snorkel"] },
      { id: "therizinosaurus_001", name: "Therizinosaurus", emoji: "\uD83E\uDD96", imageBase: "therizinosaurus", weightClass: "dinosaurs",
        stats: { strength: 78, speed: 50, defense: 68, aggression: 75 },
        trump: { name: "Scythe Claws", bonus: 18, desc: "3-foot razor claws" },
        facts: ["Had 3-foot claws \u2014 longest of any animal ever", "Was actually a plant-eater despite the terrifying claws", "Looked like a giant feathered sloth"] },
      { id: "pteranodon_001", name: "Pteranodon", emoji: "\uD83E\uDD85", imageBase: "pteranodon", weightClass: "dinosaurs",
        stats: { strength: 45, speed: 95, defense: 35, aggression: 72 },
        trump: { name: "Dive Bomb", bonus: 16, desc: "Attacks from the sky" },
        facts: ["Wingspan of 23 feet but weighed only 55 lbs", "Not a dinosaur \u2014 it's a flying reptile", "Had no teeth \u2014 scooped fish with its beak like a pelican"] },
      { id: "quetzalcoatlus_001", name: "Quetzalcoatlus", emoji: "\uD83E\uDD85", imageBase: "quetzalcoatlus", weightClass: "dinosaurs",
        stats: { strength: 62, speed: 88, defense: 45, aggression: 70 },
        trump: { name: "Sky Giant", bonus: 18, desc: "Largest flying animal ever" },
        facts: ["Tall as a giraffe with a 36-foot wingspan", "Could fly at 80 mph for thousands of miles non-stop", "Named after the Aztec feathered serpent god"] },
      { id: "megalosaurus_001", name: "Megalosaurus", emoji: "\uD83E\uDD96", imageBase: "megalosaurus", weightClass: "dinosaurs",
        stats: { strength: 78, speed: 65, defense: 65, aggression: 80 },
        trump: { name: "First Hunter", bonus: 15, desc: "The first dinosaur ever found" },
        facts: ["First dinosaur ever scientifically named, in 1824", "Was originally thought to be a giant lizard, not a dinosaur", "Roamed England 166 million years ago"] },
    ];
    allAnimals.forEach(function(a) {
      a.fightScore = a.stats.strength + a.stats.speed + a.stats.defense + a.stats.aggression;
    });

    function getAnimalsByClass(wc) {
      return allAnimals.filter(function(a) { return a.weightClass === wc; });
    }

    // Default for backward compat
    var animals = getAnimalsByClass("heavyweight");

    // ==================== NAME GENERATOR ====================
    var NAME_ADJECTIVES = [
      "Swift", "Fierce", "Shadow", "Thunder", "Iron", "Silent", "Blazing", "Frost",
      "Storm", "Savage", "Golden", "Mystic", "Dark", "Brave", "Wild", "Mighty",
      "Rapid", "Phantom", "Steel", "Noble"
    ];
    var NAME_ANIMALS = animals.map(function(a) { return a.name.replace(/ /g, ""); });

    function generateRandomName() {
      var adj = NAME_ADJECTIVES[Math.floor(Math.random() * NAME_ADJECTIVES.length)];
      var anm = NAME_ANIMALS[Math.floor(Math.random() * NAME_ANIMALS.length)];
      var num = Math.floor(Math.random() * 90) + 10;
      return adj + anm + num;
    }

    function checkNameAvailable(name) {
      if (!sb) return Promise.resolve(true);
      return sb.from('leaderboard').select('player_name').eq('player_name', name).limit(1)
        .then(function(r) {
          if (r.error) return true;
          return r.data.length === 0;
        })
        .catch(function() { return true; });
    }

    function generateUniqueName() {
      var name = generateRandomName();
      return checkNameAvailable(name).then(function(available) {
        if (available) return name;
        return generateUniqueName();
      });
    }

    // ==================== TOURNAMENT LOGIC ====================
    function shuffleArray(arr) {
      var a = arr.slice();
      for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
      }
      return a;
    }

    function generateTournamentMatchups(animalList) {
      var list = animalList || animals;
      var pairings = [];
      for (var i = 0; i < list.length; i++) {
        for (var j = i + 1; j < list.length; j++) {
          pairings.push({ left: list[i], right: list[j] });
        }
      }
      var shuffled = shuffleArray(pairings);
      return shuffled.slice(0, TOURNAMENT_ROUNDS).map(function(pair) {
        if (Math.random() < 0.5) return { left: pair.right, right: pair.left };
        return pair;
      });
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    var TRUMP_CHANCE = 0.30; // 30% chance per round

    function determineWinner(a1, a2) {
      var s1 = Math.round(a1.fightScore * (0.95 + Math.random() * 0.1));
      var s2 = Math.round(a2.fightScore * (0.95 + Math.random() * 0.1));
      var trumpCard = null;
      if (Math.random() < TRUMP_CHANCE) {
        // One animal triggers their trump card
        if (Math.random() < 0.5 && a1.trump) {
          s1 += a1.trump.bonus;
          trumpCard = { animal: a1, trump: a1.trump, side: "left" };
        } else if (a2.trump) {
          s2 += a2.trump.bonus;
          trumpCard = { animal: a2, trump: a2.trump, side: "right" };
        } else if (a1.trump) {
          s1 += a1.trump.bonus;
          trumpCard = { animal: a1, trump: a1.trump, side: "left" };
        }
      }
      return { winner: s1 > s2 ? a1 : a2, scores: { left: s1, right: s2 }, trumpCard: trumpCard };
    }

    // ==================== STORAGE ====================
    function loadLeaderboard() {
      try { var d = localStorage.getItem("af_leaderboard"); return d ? JSON.parse(d) : []; } catch(ex) { return []; }
    }
    function saveLeaderboard(entries) {
      try { localStorage.setItem("af_leaderboard", JSON.stringify(entries)); } catch(ex) {}
    }
    function loadSession() {
      try { var d = localStorage.getItem("af_session"); return d ? JSON.parse(d) : null; } catch(ex) { return null; }
    }
    function saveSession(session) {
      try { localStorage.setItem("af_session", JSON.stringify(session)); } catch(ex) {}
    }
    function updateLocalLeaderboard(name, score) {
      var entries = loadLeaderboard();
      var existing = entries.find(function(x) { return x.name === name; });
      if (existing) {
        if (score > existing.score) { existing.score = score; existing.timestamp = Date.now(); }
      } else {
        entries.push({ name: name, score: score, timestamp: Date.now() });
      }
      entries.sort(function(a, b) { return b.score - a.score || a.timestamp - b.timestamp; });
      saveLeaderboard(entries.slice(0, 20));
    }

    // ==================== COMPONENTS ====================

    function AnimalAvatar(props) {
      var animal = props.animal, size = props.size || "normal";
      var extensions = ["jpg", "jpeg", "png", "webp"];
      var ref = useState(0), extIndex = ref[0], setExtIndex = ref[1];
      var ref2 = useState(false), allFailed = ref2[0], setAllFailed = ref2[1];
      var sizeClass = size === "large" ? "w-28 h-28 sm:w-36 sm:h-36" : "w-20 h-20 sm:w-28 sm:h-28";
      var emojiSize = size === "large" ? "text-7xl sm:text-8xl" : "text-5xl sm:text-6xl";
      if (allFailed || !animal.imageBase) {
        return e("span", { className: emojiSize + " leading-none select-none" }, animal.emoji);
      }
      return e("img", {
        src: "images/" + animal.imageBase + "." + extensions[extIndex],
        alt: animal.name,
        className: sizeClass + " object-cover rounded-full border-2 border-white/20",
        onError: function() {
          if (extIndex < extensions.length - 1) setExtIndex(function(i) { return i + 1; });
          else setAllFailed(true);
        }
      });
    }

    function LightningBolt(props) {
      if (!props.visible) return null;
      return e("div", { className: "absolute inset-0 flex items-center justify-center z-20 pointer-events-none lightning-flash" },
        e("svg", { width: "80", height: "120", viewBox: "0 0 80 120", fill: "none" },
          e("defs", null,
            e("linearGradient", { id: "boltGrad", x1: "0%", y1: "0%", x2: "0%", y2: "100%" },
              e("stop", { offset: "0%", stopColor: "#FFD700" }),
              e("stop", { offset: "100%", stopColor: "#FF8C00" })
            )
          ),
          e("polygon", { points: "45,0 15,55 35,55 20,120 65,50 42,50 58,0", fill: "url(#boltGrad)", stroke: "#FFA500", strokeWidth: "2" })
        ),
        e("div", { className: "absolute inset-0 bg-yellow-400/10 rounded-3xl" })
      );
    }

    function StatBar(props) {
      var label = props.label, v1 = props.value1, v2 = props.value2, delay = props.delay, show = props.showResult;
      var c1 = v1 >= v2 ? "bg-green-400" : "bg-red-400";
      var c2 = v2 >= v1 ? "bg-green-400" : "bg-red-400";
      return e("div", { className: "mb-3" },
        e("div", { className: "text-xs text-gray-400 text-center mb-1 uppercase tracking-wider font-semibold" }, label),
        e("div", { className: "flex items-center gap-2" },
          e("div", { className: "flex-1 flex justify-end" },
            e("div", { className: "w-full bg-gray-800 rounded-full h-4 overflow-hidden" },
              e("div", { className: "h-full rounded-full " + c1 + (show ? " stat-bar-animate stat-bar-delay-" + delay : ""), style: { width: show ? v1 + "%" : "0%", float: "right" } })
            )
          ),
          e("div", { className: "w-14 text-center text-xs font-bold" },
            e("span", { className: v1 >= v2 ? "text-green-400" : "text-red-400" }, v1),
            e("span", { className: "text-gray-500" }, " : "),
            e("span", { className: v2 >= v1 ? "text-green-400" : "text-red-400" }, v2)
          ),
          e("div", { className: "flex-1" },
            e("div", { className: "w-full bg-gray-800 rounded-full h-4 overflow-hidden" },
              e("div", { className: "h-full rounded-full " + c2 + (show ? " stat-bar-animate stat-bar-delay-" + delay : ""), style: { width: show ? v2 + "%" : "0%" } })
            )
          )
        )
      );
    }

    function Header(props) {
      return e("div", null,
        e("div", { className: "bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 px-4 py-3 border-b border-gray-700/50" },
          e("div", { className: "max-w-lg mx-auto flex items-center justify-between" },
            e("div", null,
              e("h1", { className: "text-lg font-black tracking-tight" },
                e("span", { className: "text-orange-400" }, "ANIMAL"),
                e("span", { className: "text-white" }, " FACEOFF")
              )
            ),
            e("div", { className: "flex items-center gap-4 text-sm" },
              props.streak >= 3 ? e("span", { className: "streak-fire font-bold text-orange-400" }, "\uD83D\uDD25" + props.streak) : null,
              e("div", { className: "text-center" },
                e("div", { className: "text-gray-400 text-xs" }, "SCORE"),
                e("div", { className: "font-bold text-orange-400" }, props.score)
              ),
              e("div", { className: "text-center" },
                e("div", { className: "text-gray-400 text-xs" }, "ROUND"),
                e("div", { className: "font-bold" }, props.round + "/" + TOURNAMENT_ROUNDS)
              ),
              e("button", { onClick: props.onLeaderboard, className: "p-2 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 active:scale-95 transition-all" }, "\uD83C\uDFC6")
            )
          )
        ),
        // Progress bar
        e("div", { className: "w-full h-1 bg-gray-800" },
          e("div", { className: "h-full bg-gradient-to-r from-orange-500 to-orange-400 transition-all duration-500", style: { width: (props.round / TOURNAMENT_ROUNDS * 100) + "%" } })
        )
      );
    }

    function AnimalCard(props) {
      var animal = props.animal, side = props.side, disabled = props.disabled, result = props.result, isWinner = props.isWinner, isLoser = props.isLoser;
      var cardClass = "animal-card relative flex flex-col items-center pt-6 sm:pt-8 p-3 sm:p-4 rounded-2xl ";
      var animClass = side === "left" ? "slide-in-left" : "slide-in-right";
      if (result) {
        if (isWinner) cardClass += "bg-gradient-to-b from-green-900/60 to-green-800/30 border-2 border-green-400/60 pulse-win ";
        else if (isLoser) cardClass += "bg-gradient-to-b from-gray-900/80 to-gray-800/40 border-2 border-gray-600/30 opacity-50 grayscale ";
      } else {
        cardClass += "bg-gradient-to-b from-gray-800/80 to-gray-700/40 border-2 border-gray-600/30 hover:border-orange-400/50 glow-pulse ";
      }
      // Pick a stable random fact per matchup
      var factRef = React.useMemo(function() {
        if (animal.facts && animal.facts.length > 0) {
          return animal.facts[Math.floor(Math.random() * animal.facts.length)];
        }
        return null;
      }, [animal.id]);
      return e("button", {
        onClick: function() { if (!disabled) props.onSelect(animal); },
        disabled: disabled,
        className: cardClass + " " + animClass + " flex-1"
      },
        isWinner && result ? e("div", { className: "absolute -top-3 left-1/2 -translate-x-1/2 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10" }, "WINNER!") : null,
        e("div", { className: "mb-2" }, e(AnimalAvatar, { animal: animal, size: "large" })),
        e("div", { className: "text-base sm:text-lg font-bold text-center leading-tight truncate w-full" }, animal.name),
        e("div", { className: "mt-1 px-1 overflow-hidden text-center fact-box" },
          factRef ? e("div", { className: "text-xs text-gray-400 leading-snug italic line-clamp-4" }, "\"\u2009" + factRef + "\u2009\"") : null
        ),
        !result && !disabled ? e("div", { className: "mt-1 text-xs text-orange-400/80 font-medium" }, "TAP TO SELECT") : null
      );
    }

    function ResultModal(props) {
      if (!props.matchup || !props.winner) return null;
      var left = props.matchup.left, right = props.matchup.right;
      var isCorrect = props.isCorrect;
      var isFinalRound = props.round >= TOURNAMENT_ROUNDS;
      var fs = props.fightScores || { left: left.fightScore, right: right.fightScore };
      var leftWon = props.winner.id === left.id;
      var trump = props.trumpCard;
      return e("div", { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-end sm:items-center justify-center z-30 p-4 fade-in" },
        e("div", { className: "bg-gray-900 rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl fade-in-up max-h-[85vh] overflow-y-auto" },
          e("div", { className: "p-5 text-center rounded-t-2xl " + (isCorrect ? "bg-gradient-to-b from-green-900/50 to-transparent" : "bg-gradient-to-b from-red-900/50 to-transparent") },
            e("div", { className: "text-4xl mb-2" }, isCorrect ? "\uD83C\uDF89" : "\uD83D\uDE14"),
            e("div", { className: "text-xl font-black " + (isCorrect ? "text-green-400" : "text-red-400") }, isCorrect ? "CORRECT!" : "WRONG!"),
            e("div", { className: "text-gray-400 text-sm mt-1" }, props.winner.name + " wins this round!"),
            isCorrect && props.streak >= 3 ? e("div", { className: "mt-2 text-orange-400 font-bold streak-fire" }, "\uD83D\uDD25 " + props.streak + " streak! +" + props.points + " pts") : null,
            trump ? e("div", { className: "mt-2 trump-flash inline-block bg-gradient-to-r from-purple-600/30 to-pink-600/30 border border-purple-400/40 rounded-full px-4 py-1.5" },
              e("span", { className: "text-purple-300 text-xs font-bold" }, "\u26A1 Special Trait - " + trump.animal.name + " \u2014 " + trump.trump.name + " "),
              e("span", { className: "text-purple-400/70 text-xs" }, "(+" + trump.trump.bonus + ")")
            ) : null
          ),
          e("div", { className: "px-5 py-2" },
            e("div", { className: "flex items-center justify-evenly mb-3" },
              e("div", { className: "text-center" },
                e("div", { className: "flex justify-center" }, e(AnimalAvatar, { animal: left })),
                e("div", { className: "text-sm font-bold mt-1" }, left.name),
                e("div", { className: "text-xs font-bold mt-1 " + (leftWon ? "text-green-400" : "text-red-400") }, "Fight: " + fs.left)
              ),
              e("div", { className: "text-gray-500 text-xs font-bold px-2" }, "VS"),
              e("div", { className: "text-center" },
                e("div", { className: "flex justify-center" }, e(AnimalAvatar, { animal: right })),
                e("div", { className: "text-sm font-bold mt-1" }, right.name),
                e("div", { className: "text-xs font-bold mt-1 " + (!leftWon ? "text-green-400" : "text-red-400") }, "Fight: " + fs.right)
              )
            ),
            e(StatBar, { label: "Strength", value1: left.stats.strength, value2: right.stats.strength, delay: 1, showResult: true }),
            e(StatBar, { label: "Speed", value1: left.stats.speed, value2: right.stats.speed, delay: 2, showResult: true }),
            e(StatBar, { label: "Defense", value1: left.stats.defense, value2: right.stats.defense, delay: 3, showResult: true }),
            e(StatBar, { label: "Aggression", value1: left.stats.aggression, value2: right.stats.aggression, delay: 4, showResult: true })
          ),
          e("div", { className: "px-5 pb-5" },
            e("button", { onClick: props.onNext, className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform shadow-lg shadow-orange-500/20" },
              isFinalRound ? "FINISH TOURNAMENT \uD83C\uDFC6" : "NEXT ROUND \u27A1\uFE0F"
            )
          )
        )
      );
    }

    function LeaderboardRow(props) {
      var entry = props.entry, rank = props.rank, isUser = props.isUser;
      var medals = ["\uD83E\uDD47", "\uD83E\uDD48", "\uD83E\uDD49"];
      return e("div", {
        className: "flex items-center justify-between p-3 rounded-xl " + (isUser ? "bg-orange-500/10 border border-orange-500/30" : "bg-gray-800/50")
      },
        e("div", { className: "flex items-center gap-3" },
          e("span", { className: "text-lg w-8 text-center" },
            rank <= 3 ? medals[rank - 1] : e("span", { className: "text-gray-500 text-sm font-bold" }, "#" + rank)
          ),
          e("span", { className: "font-semibold " + (isUser ? "text-orange-400" : "") }, entry.name + (isUser ? " (you)" : ""))
        ),
        e("span", { className: "font-bold text-lg" }, entry.score)
      );
    }

    function LeaderboardModal(props) {
      var entries = props.entries, userName = props.userName, isGlobal = props.source === "global";
      var pRank = props.playerRank;
      var pEntry = props.playerEntry;
      // Check if player is already in the top 10
      var playerInTop = entries.some(function(x) { return x.name === userName; });
      return e("div", { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-end sm:items-center justify-center z-30 p-4 fade-in" },
        e("div", { className: "bg-gray-900 rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl fade-in-up max-h-[80vh] overflow-y-auto" },
          e("div", { className: "p-5 text-center border-b border-gray-700/50" },
            e("div", { className: "text-3xl mb-2" }, "\uD83C\uDFC6"),
            e("h2", { className: "text-xl font-black" }, "LEADERBOARD"),
            e("div", { className: "inline-block mt-2 px-3 py-1 rounded-full text-xs font-bold " + (isGlobal ? "bg-green-500/20 text-green-400" : "bg-gray-700 text-gray-400") },
              isGlobal ? "\uD83C\uDF10 GLOBAL" : "\uD83D\uDCF1 THIS DEVICE"
            ),
            pRank && isGlobal ? e("div", { className: "text-sm text-gray-400 mt-1" }, "Your rank: #" + pRank) : null
          ),
          e("div", { className: "p-4" },
            entries.length === 0 ?
              e("div", { className: "text-center text-gray-500 py-8" },
                e("div", { className: "text-4xl mb-3" }, "\uD83C\uDFAE"),
                e("div", null, "No scores yet!"),
                e("div", { className: "text-sm mt-1" }, "Complete a tournament to get on the board")
              ) :
              e("div", { className: "space-y-2" },
                entries.map(function(entry, i) {
                  var isUser = entry.name === userName;
                  return e(LeaderboardRow, { key: i, entry: entry, rank: i + 1, isUser: isUser });
                }),
                // Show divider + player row if they're not in top 10
                isGlobal && !playerInTop && pEntry && pRank ? [
                  e("div", { key: "divider", className: "flex items-center gap-3 py-2" },
                    e("div", { className: "flex-1 border-t border-gray-700" }),
                    e("span", { className: "text-gray-500 text-xs" }, "\u2022 \u2022 \u2022"),
                    e("div", { className: "flex-1 border-t border-gray-700" })
                  ),
                  e(LeaderboardRow, { key: "player", entry: pEntry, rank: pRank, isUser: true })
                ] : null
              )
          ),
          e("div", { className: "px-5 pb-5" },
            e("button", { onClick: props.onClose, className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all" }, "BACK TO GAME")
          )
        )
      );
    }

    function NameEntry(props) {
      var ref = useState(""), name = ref[0], setName = ref[1];
      var errRef = useState(""), error = errRef[0], setError = errRef[1];
      var chkRef = useState(false), checking = chkRef[0], setChecking = chkRef[1];
      var rlRef = useState(false), rolling = rlRef[0], setRolling = rlRef[1];

      function genName() {
        setRolling(true);
        setError("");
        generateUniqueName().then(function(n) {
          setName(n);
          setRolling(false);
        });
      }

      function handleChange(ev) {
        var val = ev.target.value.replace(/[^a-zA-Z0-9_]/g, "").slice(0, 20);
        setName(val);
        setError("");
      }

      function handleSubmit() {
        var trimmed = name.trim();
        if (trimmed.length < 3) { setError("Name must be at least 3 characters"); return; }
        if (trimmed.length > 20) { setError("Name must be 20 characters or less"); return; }
        setChecking(true);
        setError("");
        checkNameAvailable(trimmed).then(function(available) {
          setChecking(false);
          if (available) {
            props.onSubmit(trimmed);
          } else {
            setError("Name taken, try another!");
          }
        });
      }

      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm" },
          e("div", { className: "text-6xl mb-4" }, "\uD83E\uDD81"),
          e("h1", { className: "text-3xl font-black mb-2" },
            e("span", { className: "text-orange-400" }, "ANIMAL"),
            e("span", { className: "text-white" }, " FACEOFF")
          ),
          e("p", { className: "text-gray-400 mb-6" }, "Predict the winner of epic animal battles!"),
          e("label", { className: "text-sm text-gray-400 block mb-2" }, "Choose your battle name:"),
          e("input", {
            type: "text",
            value: name,
            onChange: handleChange,
            onKeyDown: function(ev) { if (ev.key === "Enter" && name.trim().length >= 3) handleSubmit(); },
            placeholder: "Type a name...",
            maxLength: 20,
            className: "w-full bg-gray-800 border-2 border-gray-600 focus:border-orange-400 rounded-xl px-4 py-4 text-center text-orange-400 text-xl font-black placeholder-gray-600 outline-none transition-colors"
          }),
          e("div", { className: "flex items-center justify-between mt-2 mb-4 px-1" },
            error ? e("span", { className: "text-red-400 text-xs font-medium" }, error)
              : e("span", { className: "text-gray-600 text-xs" }, name.length + "/20"),
            e("button", {
              onClick: genName, disabled: rolling,
              className: "text-gray-400 hover:text-orange-400 transition-colors text-sm inline-flex items-center gap-1 disabled:opacity-30"
            },
              e("span", { className: "text-base" + (rolling ? " animate-spin" : "") }, "\uD83C\uDFB2"),
              " Random"
            )
          ),
          e("button", {
            onClick: handleSubmit, disabled: checking || rolling || name.trim().length < 3,
            className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg disabled:opacity-30 disabled:cursor-not-allowed active:scale-95 transition-all shadow-lg shadow-orange-500/20"
          }, checking ? "CHECKING..." : "LET'S GO! \uD83D\uDD25")
        )
      );
    }

    function ClassSelect(props) {
      var classes = Object.keys(WEIGHT_CLASSES);
      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm" },
          e("div", { className: "text-6xl mb-4" }, "\u2694\uFE0F"),
          e("h1", { className: "text-3xl font-black mb-2" },
            e("span", { className: "text-orange-400" }, "CHOOSE YOUR"),
            e("span", { className: "text-white" }, " DIVISION")
          ),
          e("p", { className: "text-gray-400 mb-6" }, "Each division has its own set of animals"),
          e("div", { className: "space-y-3" },
            classes.map(function(key) {
              var wc = WEIGHT_CLASSES[key];
              return e("button", {
                key: key,
                onClick: function() { props.onSelect(key); },
                className: "w-full p-4 bg-gray-800/80 border-2 border-gray-600/30 hover:border-orange-400/50 rounded-xl active:scale-95 transition-all text-left"
              },
                e("div", { className: "flex items-center gap-3" },
                  e("span", { className: "text-3xl" }, wc.emoji),
                  e("div", null,
                    e("div", { className: "font-bold text-lg text-white" }, wc.label),
                    e("div", { className: "text-xs text-gray-400" }, wc.desc),
                    e("div", { className: "text-xs text-orange-400/70 mt-1" }, getAnimalsByClass(key).length + " animals")
                  )
                )
              );
            })
          ),
          e("div", { className: "mt-6" },
            e("button", {
              onClick: props.onLeaderboard,
              className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all"
            }, "VIEW LEADERBOARD \uD83C\uDFC6")
          )
        )
      );
    }

    function TournamentReady(props) {
      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm" },
          e("div", { className: "text-6xl mb-4" }, "\u2694\uFE0F"),
          e("h1", { className: "text-3xl font-black mb-2" },
            e("span", { className: "text-orange-400" }, "TOURNAMENT"),
            e("span", { className: "text-white" }, " MODE")
          ),
          e("p", { className: "text-gray-400 mb-2" },
            "Welcome, " + props.playerName + "! ",
            e("button", { onClick: props.onChangeName, className: "text-orange-400 underline text-sm" }, "Not you?")
          ),
          props.weightClass && WEIGHT_CLASSES[props.weightClass] ? e("div", { className: "inline-block mb-3 px-4 py-1 rounded-full bg-orange-500/20 text-orange-400 text-sm font-bold" },
            WEIGHT_CLASSES[props.weightClass].emoji + " " + WEIGHT_CLASSES[props.weightClass].label + " Division"
          ) : null,
          e("p", { className: "text-gray-500 text-sm mb-4" }, TOURNAMENT_ROUNDS + " rounds \u2022 No repeated matchups \u2022 Trump cards enabled!"),
          e("button", { onClick: props.onChangeClass, className: "text-gray-500 hover:text-orange-400 text-xs mb-6 underline transition-colors" }, "Change division"),
          e("div", { className: "space-y-3" },
            e("button", {
              onClick: props.onStart,
              className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-all shadow-lg shadow-orange-500/20"
            }, "START TOURNAMENT \u2694\uFE0F"),
            e("button", {
              onClick: props.onLeaderboard,
              className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all"
            }, "VIEW LEADERBOARD \uD83C\uDFC6")
          )
        )
      );
    }

    function formatTime(secs) {
      var m = Math.floor(secs / 60);
      var s = secs % 60;
      return m > 0 ? m + "m " + s + "s" : s + "s";
    }

    function TournamentEnd(props) {
      var pct = Math.round((props.roundsCorrect / TOURNAMENT_ROUNDS) * 100);
      var grade;
      if (pct >= 90) grade = { label: "LEGENDARY", color: "text-yellow-400", emoji: "\uD83C\uDFC6" };
      else if (pct >= 70) grade = { label: "EXCELLENT", color: "text-green-400", emoji: "\uD83C\uDF1F" };
      else if (pct >= 50) grade = { label: "GOOD", color: "text-blue-400", emoji: "\uD83D\uDC4D" };
      else grade = { label: "KEEP TRYING", color: "text-gray-400", emoji: "\uD83D\uDCAA" };

      var timeStr = props.timeSeconds ? formatTime(props.timeSeconds) : null;
      var copiedRef = useState(false), copied = copiedRef[0], setCopied = copiedRef[1];
      var profileRef = useState(null), profile = profileRef[0], setProfile = profileRef[1];
      var profileLoadedRef = useState(false), profileLoaded = profileLoadedRef[0], setProfileLoaded = profileLoadedRef[1];

      // Fetch player profile for combined score breakdown
      useEffect(function() {
        fetchPlayerProfile(props.playerName).then(function(p) {
          setProfile(p);
          setProfileLoaded(true);
        });
      }, [props.playerName]);

      var divLabel = props.weightClass && WEIGHT_CLASSES[props.weightClass] ? WEIGHT_CLASSES[props.weightClass].label : "";
      var combinedScore = profile ? (profile.score || 0) : props.score;

      function handleShare() {
        var shareText = "\uD83E\uDD81\u2694\uFE0F Animal Faceoff ‚Äî " + divLabel + " Division\n\uD83C\uDFAF " + props.score + " pts (" + pct + "% accuracy" + (timeStr ? ", " + timeStr : "") + ")\n\uD83C\uDFC6 Leaderboard: " + combinedScore + "\n\nCan you beat me? \uD83D\uDC47\nhttps://udipta-dev.github.io/animal-face-off/";
        if (navigator.share) {
          navigator.share({ title: "Animal Faceoff", text: shareText }).catch(function() {});
        } else {
          navigator.clipboard.writeText(shareText).then(function() {
            setCopied(true);
            setTimeout(function() { setCopied(false); }, 2000);
          }).catch(function() {});
        }
      }

      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6 overflow-y-auto" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm my-auto" },
          e("div", { className: "text-5xl mb-3" }, grade.emoji),
          e("h1", { className: "text-2xl font-black mb-1 " + grade.color }, grade.label),
          e("p", { className: "text-gray-400 mb-1 text-sm" }, "Tournament Complete!"),
          divLabel ? e("div", { className: "inline-block mb-4 px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 text-xs font-bold" },
            (WEIGHT_CLASSES[props.weightClass] ? WEIGHT_CLASSES[props.weightClass].emoji + " " : "") + divLabel + " Division"
          ) : e("div", { className: "mb-4" }),

          // This run stats
          e("div", { className: "grid grid-cols-2 gap-2 mb-2" },
            e("div", { className: "bg-gray-800/60 rounded-xl p-3" },
              e("div", { className: "text-2xl font-black text-orange-400" }, props.score),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Score")
            ),
            e("div", { className: "bg-gray-800/60 rounded-xl p-3" },
              e("div", { className: "text-2xl font-black text-green-400" }, props.roundsCorrect + "/" + TOURNAMENT_ROUNDS),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Correct")
            ),
            e("div", { className: "bg-gray-800/60 rounded-xl p-3" },
              e("div", { className: "text-2xl font-black text-orange-400" }, props.bestStreak),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Best Streak")
            ),
            e("div", { className: "bg-gray-800/60 rounded-xl p-3" },
              e("div", { className: "text-2xl font-black text-blue-400" }, pct + "%"),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Accuracy")
            )
          ),
          timeStr ? e("div", { className: "bg-gray-800/60 rounded-xl p-2 mb-3 flex items-center justify-center gap-2" },
            e("span", { className: "text-gray-400 text-sm" }, "\u23F1\uFE0F"),
            e("span", { className: "text-white font-bold text-sm" }, timeStr),
            e("span", { className: "text-xs text-gray-500" }, "total time")
          ) : e("div", { className: "mb-3" }),

          // Combined leaderboard score
          e("div", { className: "bg-gradient-to-r from-orange-500/10 to-yellow-500/10 border border-orange-400/30 rounded-xl p-4 mb-4" },
            e("div", { className: "text-xs text-gray-400 mb-1" }, "Combination of your best scores across all divisions"),
            e("div", { className: "text-3xl font-black text-orange-400" }, profileLoaded ? combinedScore : "..."),
          ),

          e("div", { className: "space-y-2" },
            e("button", {
              onClick: handleShare,
              className: "w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-all shadow-lg shadow-green-500/20"
            }, copied ? "COPIED! \u2705" : "SHARE \uD83D\uDCE4"),
            e("button", {
              onClick: props.onLeaderboard,
              className: "w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-all shadow-lg shadow-orange-500/20"
            }, "VIEW LEADERBOARD \uD83C\uDFC6"),
            e("button", {
              onClick: props.onPlayAgain,
              className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all"
            }, "PLAY AGAIN \uD83D\uDD01")
          )
        )
      );
    }

    // ==================== MAIN GAME ====================
    function AnimalFaceoffGame() {
      var gsRef = useState("loading"), gameState = gsRef[0], setGameState = gsRef[1];
      var muRef = useState(null), currentMatchup = muRef[0], setCurrentMatchup = muRef[1];
      var saRef = useState(null), selectedAnimal = saRef[0], setSelectedAnimal = saRef[1];
      var wRef = useState(null), winner = wRef[0], setWinner = wRef[1];
      var scRef = useState(0), score = scRef[0], setScore = scRef[1];
      var rdRef = useState(1), round = rdRef[0], setRound = rdRef[1];
      var stRef = useState(0), streak = stRef[0], setStreak = stRef[1];
      var unRef = useState(""), userName = unRef[0], setUserName = unRef[1];
      var lbRef = useState([]), leaderboard = lbRef[0], setLeaderboard = lbRef[1];
      var slRef = useState(false), showLightning = slRef[0], setShowLightning = slRef[1];
      var lpRef = useState(0), lastPoints = lpRef[0], setLastPoints = lpRef[1];
      var akRef = useState(0), animKey = akRef[0], setAnimKey = akRef[1];
      // Tournament state
      var tmRef = useState([]), tournamentMatchups = tmRef[0], setTournamentMatchups = tmRef[1];
      var tiRef = useState(null), tournamentId = tiRef[0], setTournamentId = tiRef[1];
      var rcRef = useState(0), roundsCorrect = rcRef[0], setRoundsCorrect = rcRef[1];
      var bsRef = useState(0), bestStreak = bsRef[0], setBestStreak = bsRef[1];
      var lsRef = useState("local"), leaderboardSource = lsRef[0], setLeaderboardSource = lsRef[1];
      var fsRef = useState(null), fightScores = fsRef[0], setFightScores = fsRef[1];
      var tcRef = useState(null), activeTrump = tcRef[0], setActiveTrump = tcRef[1];
      var wcRef = useState(null), weightClass = wcRef[0], setWeightClass = wcRef[1];
      var siRef = useState(false), showInfo = siRef[0], setShowInfo = siRef[1];
      var prRef = useState(null), playerRank = prRef[0], setPlayerRank = prRef[1];
      var peRef = useState(null), playerEntry = peRef[0], setPlayerEntry = peRef[1];
      var ttRef = useState(null), tournamentStart = ttRef[0], setTournamentStart = ttRef[1];
      var tdRef = useState(0), tournamentTime = tdRef[0], setTournamentTime = tdRef[1];
      var prevGameStateRef = useRef("loading");

      // Initialize
      useEffect(function() {
        var session = loadSession();
        if (session && session.name) {
          setUserName(session.name);
          if (session.weightClass) setWeightClass(session.weightClass);
          if (session.tournamentMatchups && session.tournamentMatchups.length > 0 && session.gameState === "playing") {
            setTournamentMatchups(session.tournamentMatchups);
            setTournamentId(session.tournamentId);
            setScore(session.score || 0);
            setRound(session.round || 1);
            setStreak(session.streak || 0);
            setRoundsCorrect(session.roundsCorrect || 0);
            setBestStreak(session.bestStreak || 0);
            setWeightClass(session.weightClass || "heavyweight");
            setCurrentMatchup(session.tournamentMatchups[(session.round || 1) - 1]);
            setAnimKey(function(k) { return k + 1; });
            setGameState("playing");
          } else {
            setGameState("class_select");
          }
        } else {
          setGameState("name_entry");
        }
        setLeaderboard(loadLeaderboard());
      }, []);

      // Save session when playing
      useEffect(function() {
        if (userName && gameState === "playing" && tournamentMatchups.length > 0) {
          saveSession({
            name: userName, score: score, round: round, streak: streak,
            roundsCorrect: roundsCorrect, bestStreak: bestStreak,
            tournamentMatchups: tournamentMatchups, tournamentId: tournamentId,
            weightClass: weightClass, gameState: "playing"
          });
        }
      }, [score, round, streak, userName, roundsCorrect, bestStreak, tournamentMatchups, tournamentId, gameState]);

      function handleNameSubmit(name) {
        setUserName(name);
        saveSession({ name: name });
        setGameState("class_select");
      }

      function handleClassSelect(wc) {
        setWeightClass(wc);
        saveSession({ name: userName, weightClass: wc });
        setGameState("tournament_ready");
      }

      function handleStartTournament() {
        var classAnimals = weightClass ? getAnimalsByClass(weightClass) : animals;
        var matchups = generateTournamentMatchups(classAnimals);
        var tid = generateUUID();
        setTournamentMatchups(matchups);
        setTournamentId(tid);
        setScore(0);
        setRound(1);
        setStreak(0);
        setRoundsCorrect(0);
        setBestStreak(0);
        setCurrentMatchup(matchups[0]);
        setSelectedAnimal(null);
        setWinner(null);
        setShowLightning(false);
        setAnimKey(function(k) { return k + 1; });
        setTournamentStart(Date.now());
        setTournamentTime(0);
        setGameState("playing");
      }

      function handleAnimalSelect(animal) {
        if (gameState !== "playing" || !currentMatchup) return;
        setSelectedAnimal(animal);
        setShowLightning(true);
        setGameState("selected");
        var result = determineWinner(currentMatchup.left, currentMatchup.right);
        setWinner(result.winner);
        setFightScores(result.scores);
        setActiveTrump(result.trumpCard);
        var isCorrect = animal.id === result.winner.id;
        var newStreak = isCorrect ? streak + 1 : 0;
        var streakBonus = isCorrect && newStreak > 0 && newStreak % 5 === 0 ? 5 : 0;
        var points = isCorrect ? 10 + streakBonus : 0;
        setStreak(newStreak);
        setLastPoints(points);
        setScore(function(s) { return s + points; });
        if (isCorrect) setRoundsCorrect(function(rc) { return rc + 1; });
        setBestStreak(function(prev) { return Math.max(prev, newStreak); });
        setTimeout(function() { setShowLightning(false); setGameState("result"); }, 500);
      }

      function handleNextRound() {
        var nextRound = round + 1;
        if (nextRound > TOURNAMENT_ROUNDS) {
          // Tournament over
          var elapsed = tournamentStart ? Math.round((Date.now() - tournamentStart) / 1000) : 0;
          setTournamentTime(elapsed);
          updateLocalLeaderboard(userName, score);
          setLeaderboard(loadLeaderboard());
          submitScoreToSupabase(userName, weightClass, score, bestStreak, roundsCorrect);
          saveSession({ name: userName, weightClass: weightClass });
          setGameState("tournament_end");
        } else {
          setRound(nextRound);
          setCurrentMatchup(tournamentMatchups[nextRound - 1]);
          setSelectedAnimal(null);
          setWinner(null);
          setShowLightning(false);
          setAnimKey(function(k) { return k + 1; });
          setGameState("playing");
        }
      }

      function handlePlayAgain() {
        saveSession({ name: userName });
        setGameState("class_select");
      }

      function handleShowLeaderboard() {
        prevGameStateRef.current = gameState;
        updateLocalLeaderboard(userName, score);
        setLeaderboard(loadLeaderboard());
        setLeaderboardSource("local");
        setPlayerRank(null);
        setPlayerEntry(null);
        setGameState("leaderboard");
        fetchGlobalLeaderboard(userName).then(function(data) {
          if (data && data.top && data.top.length > 0) {
            var formatted = data.top.map(function(row) {
              return { name: row.player_name, score: row.score, hwScore: row.best_hw_score || 0, mwScore: row.best_mw_score || 0 };
            });
            setLeaderboard(formatted);
            setLeaderboardSource("global");
            if (data.player) {
              setPlayerEntry({ name: data.player.player_name, score: data.player.score, hwScore: data.player.best_hw_score || 0, mwScore: data.player.best_mw_score || 0 });
            }
            if (data.playerRank) {
              setPlayerRank(data.playerRank);
            }
          }
        });
      }

      function handleCloseLeaderboard() {
        var prev = prevGameStateRef.current;
        if (prev === "playing" || prev === "selected" || prev === "result") {
          setGameState("playing");
        } else if (prev === "tournament_end") {
          setGameState("tournament_end");
        } else if (prev === "tournament_ready") {
          setGameState("tournament_ready");
        } else {
          setGameState("class_select");
        }
      }

      // Loading
      if (gameState === "loading") {
        return e("div", { className: "min-h-screen flex items-center justify-center" },
          e("div", { className: "text-2xl font-bold text-orange-400 animate-pulse" }, "Loading...")
        );
      }

      // Name entry
      if (gameState === "name_entry") return e(NameEntry, { onSubmit: handleNameSubmit });

      // Class select
      if (gameState === "class_select") {
        return e(ClassSelect, { onSelect: handleClassSelect, onLeaderboard: handleShowLeaderboard });
      }

      // Tournament ready
      if (gameState === "tournament_ready") {
        return e(TournamentReady, {
          playerName: userName,
          weightClass: weightClass,
          onStart: handleStartTournament,
          onLeaderboard: handleShowLeaderboard,
          onChangeName: function() { setUserName(""); saveSession({}); setGameState("name_entry"); },
          onChangeClass: function() { setGameState("class_select"); }
        });
      }

      // Tournament end
      if (gameState === "tournament_end") {
        return e(TournamentEnd, {
          score: score, roundsCorrect: roundsCorrect, bestStreak: bestStreak,
          timeSeconds: tournamentTime, weightClass: weightClass, playerName: userName,
          onPlayAgain: handlePlayAgain, onLeaderboard: handleShowLeaderboard
        });
      }

      // Leaderboard (standalone, from tournament_ready or tournament_end)
      if (gameState === "leaderboard") {
        return e(LeaderboardModal, { entries: leaderboard, userName: userName, source: leaderboardSource, playerRank: playerRank, playerEntry: playerEntry, onClose: handleCloseLeaderboard });
      }

      var isCorrect = selectedAnimal && winner && selectedAnimal.id === winner.id;

      // Main game (playing / selected / result)
      return e("div", { className: "min-h-screen flex flex-col bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950" },
        e(Header, { score: score, round: round, streak: streak, onLeaderboard: handleShowLeaderboard }),
        e("div", { className: "flex-1 flex flex-col items-center pt-3 sm:pt-4 px-4 sm:px-6" },
          e("div", { className: "w-full max-w-lg" },
            e("div", { className: "text-center mb-2 fade-in" },
              e("div", { className: "text-sm text-gray-400 uppercase tracking-widest font-semibold" }, "Who Would Win?")
            ),
            currentMatchup ? e("div", { className: "relative flex items-start gap-0", key: animKey },
              e(AnimalCard, { animal: currentMatchup.left, onSelect: handleAnimalSelect, side: "left", disabled: gameState !== "playing", result: gameState === "result", isWinner: gameState === "result" && winner && winner.id === currentMatchup.left.id, isLoser: gameState === "result" && winner && winner.id !== currentMatchup.left.id }),
              e("div", { className: "flex-shrink-0 z-10 vs-pop -mx-5", style: { marginTop: "calc(2rem + 2rem)" } },
                e("div", { className: "w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/30 border-2 border-orange-300/30" },
                  e("span", { className: "text-white font-black text-sm sm:text-base" }, "VS")
                )
              ),
              e(LightningBolt, { visible: showLightning }),
              e(AnimalCard, { animal: currentMatchup.right, onSelect: handleAnimalSelect, side: "right", disabled: gameState !== "playing", result: gameState === "result", isWinner: gameState === "result" && winner && winner.id === currentMatchup.right.id, isLoser: gameState === "result" && winner && winner.id !== currentMatchup.right.id })
            ) : null,
            streak >= 3 && gameState === "playing" ? e("div", { className: "text-center mt-2 fade-in" },
              e("span", { className: "text-orange-400 font-bold streak-fire text-sm" }, "\uD83D\uDD25 " + streak + " correct in a row!")
            ) : null,
            // How scoring works - ? icon
            e("div", { className: "text-center mt-2" },
              e("button", { onClick: function() { setShowInfo(!showInfo); }, className: "text-gray-500 hover:text-gray-300 transition-colors inline-flex items-center gap-1 text-xs" },
                e("span", { className: "w-5 h-5 rounded-full border border-gray-500 inline-flex items-center justify-center text-xs font-bold" }, "?"),
                e("span", null, "How does scoring work?")
              ),
              showInfo ? e("div", { className: "mt-2 bg-gray-800/90 rounded-xl p-4 text-left text-xs text-gray-300 border border-gray-700 fade-in" },
                e("p", { className: "font-bold text-orange-400 mb-2" }, "How each round works:"),
                e("p", { className: "mb-1" }, "Every animal has 4 stats: Strength, Speed, Defense, and Aggression. These add up to a base power score."),
                e("p", { className: "mb-1" }, "Each round, both animals get a small random boost or penalty (\u00B15%) to keep things exciting. So a slightly weaker animal can still pull off an upset!"),
                e("p", { className: "mb-1" }, "\u26A1 Trump Cards: Each animal has a special ability with a 30% chance of activating per round. When triggered, it gives a bonus point boost!"),
                e("p", { className: "mb-1" }, "You get 10 points for each correct pick. Land 5 in a row? Bonus 5 points!"),
                e("p", { className: "text-gray-500 mt-2" }, "Tip: The stronger animal usually wins, but trump cards can flip anything!")
              ) : null
            )
          )
        ),
        e("div", { className: "text-center py-3 text-gray-500 text-xs" },
          weightClass && WEIGHT_CLASSES[weightClass] ? e("span", { className: "text-gray-600" }, WEIGHT_CLASSES[weightClass].emoji + " " + WEIGHT_CLASSES[weightClass].label + " \u2022 ") : null,
          e("span", null, "Playing as "),
          e("button", {
            onClick: function() { setUserName(""); saveSession({}); setGameState("name_entry"); },
            className: "text-orange-400 font-semibold underline decoration-dotted underline-offset-2 hover:text-orange-300 transition-colors"
          }, userName),
          e("span", { className: "text-gray-600" }, " \u2022 tap name to change")
        ),
        gameState === "result" ? e(ResultModal, { matchup: currentMatchup, winner: winner, selectedAnimal: selectedAnimal, points: lastPoints, isCorrect: isCorrect, streak: streak, round: round, fightScores: fightScores, trumpCard: activeTrump, onNext: handleNextRound }) : null
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(e(AnimalFaceoffGame));
  </script>
</body>
</html>
