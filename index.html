<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Animal Faceoff</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a1a;
      color: white;
      overflow-x: hidden;
      min-height: 100vh;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    @keyframes slideInLeft {
      from { transform: translateX(-120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes lightningFlash {
      0% { opacity: 0; transform: scale(0.5); }
      30% { opacity: 1; transform: scale(1.2); }
      60% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.1); }
    }
    @keyframes pulseWin {
      0% { transform: scale(1); }
      50% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }
    @keyframes statBarGrow { from { width: 0%; } }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes vsPopIn {
      0% { transform: scale(0) rotate(-30deg); opacity: 0; }
      60% { transform: scale(1.3) rotate(5deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(255,165,0,0.3); }
      50% { box-shadow: 0 0 40px rgba(255,165,0,0.6); }
    }
    @keyframes streakFire {
      0%, 100% { text-shadow: 0 0 10px #ff6600, 0 0 20px #ff3300; }
      50% { text-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300, 0 0 60px #ff0000; }
    }
    .slide-in-left { animation: slideInLeft 0.5s ease-out forwards; }
    .slide-in-right { animation: slideInRight 0.5s ease-out forwards; }
    .lightning-flash { animation: lightningFlash 0.4s ease-out forwards; }
    .pulse-win { animation: pulseWin 0.6s ease-in-out infinite; }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
    .vs-pop { animation: vsPopIn 0.6s ease-out forwards; animation-delay: 0.3s; opacity: 0; }
    .glow-pulse { animation: glowPulse 2s ease-in-out infinite; }
    .streak-fire { animation: streakFire 1s ease-in-out infinite; }
    .stat-bar-animate { animation: statBarGrow 0.8s ease-out forwards; }
    .stat-bar-delay-1 { animation-delay: 0.1s; }
    .stat-bar-delay-2 { animation-delay: 0.2s; }
    .stat-bar-delay-3 { animation-delay: 0.3s; }
    .stat-bar-delay-4 { animation-delay: 0.4s; }
    .animal-card {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }
    .animal-card:active { transform: scale(0.96); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    var e = React.createElement;
    var useState = React.useState, useEffect = React.useEffect, useCallback = React.useCallback, useRef = React.useRef;

    // ==================== CONFIG ====================
    var TOURNAMENT_ROUNDS = 20;

    // ==================== SUPABASE ====================
    var SUPABASE_URL = 'https://mteintczrnpylwxnohvw.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10ZWludGN6cm5weWx3eG5vaHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjg4NjQsImV4cCI6MjA4NjgwNDg2NH0.V0oRv6nvfnPB1fC7tAh9rcwgA5m28iIXj9DjVGUdEu0';
    var sb = null;
    try {
      if (window.supabase && window.supabase.createClient && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch(ex) { console.warn('Supabase init failed:', ex); }

    function submitScoreToSupabase(entry) {
      if (!sb) return Promise.resolve(null);
      return sb.from('leaderboard').insert([entry])
        .then(function(r) { if (r.error) console.warn('Supabase insert error:', r.error.message); return r; })
        .catch(function(err) { console.warn('Supabase submit failed:', err); return null; });
    }

    function fetchGlobalLeaderboard() {
      if (!sb) return Promise.resolve(null);
      return sb.from('leaderboard').select('player_name, score, streak, rounds_correct, created_at')
        .order('score', { ascending: false }).order('created_at', { ascending: true }).limit(20)
        .then(function(r) {
          if (r.error) { console.warn('Supabase fetch error:', r.error.message); return null; }
          return r.data;
        })
        .catch(function(err) { console.warn('Supabase fetch failed:', err); return null; });
    }

    // ==================== ANIMAL DATABASE ====================
    var animals = [
      { id: "lion_001", name: "Lion", emoji: "\uD83E\uDD81", imageBase: "lion", weightClass: "heavyweight",
        stats: { strength: 85, speed: 75, defense: 70, aggression: 90 } },
      { id: "tiger_001", name: "Tiger", emoji: "\uD83D\uDC2F", imageBase: "tiger", weightClass: "heavyweight",
        stats: { strength: 90, speed: 80, defense: 65, aggression: 85 } },
      { id: "grizzly_001", name: "Grizzly Bear", emoji: "\uD83D\uDC3B", imageBase: "grizzly-bear", weightClass: "heavyweight",
        stats: { strength: 95, speed: 60, defense: 85, aggression: 80 } },
      { id: "polar_001", name: "Polar Bear", emoji: "\u2744\uFE0F", imageBase: "polar-bear", weightClass: "heavyweight",
        stats: { strength: 95, speed: 58, defense: 90, aggression: 82 } },
      { id: "gorilla_001", name: "Gorilla", emoji: "\uD83E\uDD8D", imageBase: "gorilla", weightClass: "heavyweight",
        stats: { strength: 100, speed: 55, defense: 75, aggression: 70 } },
      { id: "croc_001", name: "Crocodile", emoji: "\uD83D\uDC0A", imageBase: "crocodile", weightClass: "heavyweight",
        stats: { strength: 88, speed: 45, defense: 92, aggression: 85 } },
      { id: "moose_001", name: "Moose", emoji: "\uD83E\uDD8C", imageBase: "moose", weightClass: "heavyweight",
        stats: { strength: 82, speed: 65, defense: 68, aggression: 72 } },
      { id: "anaconda_001", name: "Anaconda", emoji: "\uD83D\uDC0D", imageBase: "anaconda", weightClass: "heavyweight",
        stats: { strength: 78, speed: 40, defense: 70, aggression: 80 } },
      { id: "black_bear_001", name: "Black Bear", emoji: "\uD83D\uDC3B", imageBase: "black-bear", weightClass: "heavyweight",
        stats: { strength: 78, speed: 65, defense: 72, aggression: 68 } },
      { id: "gaur_001", name: "Gaur", emoji: "\uD83D\uDC02", imageBase: "gaur", weightClass: "heavyweight",
        stats: { strength: 92, speed: 58, defense: 70, aggression: 88 } },
      { id: "bison_001", name: "American Bison", emoji: "\uD83E\uDDAC", imageBase: "american-bison", weightClass: "heavyweight",
        stats: { strength: 90, speed: 58, defense: 80, aggression: 78 } },
      { id: "jaguar_001", name: "Jaguar", emoji: "\uD83D\uDC06", imageBase: "jaguar", weightClass: "heavyweight",
        stats: { strength: 82, speed: 82, defense: 60, aggression: 88 } },
      { id: "cape_buffalo_001", name: "Cape Buffalo", emoji: "\uD83D\uDC03", imageBase: "cape-buffalo", weightClass: "heavyweight",
        stats: { strength: 90, speed: 55, defense: 82, aggression: 92 } },
      { id: "komodo_001", name: "Komodo Dragon", emoji: "\uD83E\uDD8E", imageBase: "komodo-dragon", weightClass: "heavyweight",
        stats: { strength: 72, speed: 55, defense: 82, aggression: 90 } },
      { id: "cassowary_001", name: "Cassowary", emoji: "\uD83D\uDC26", imageBase: "cassowary", weightClass: "heavyweight",
        stats: { strength: 62, speed: 75, defense: 52, aggression: 91 } },
      { id: "wildebeest_001", name: "Wildebeest", emoji: "\uD83D\uDC03", imageBase: "wildebeest", weightClass: "heavyweight",
        stats: { strength: 75, speed: 72, defense: 60, aggression: 70 } },
      { id: "kangaroo_001", name: "Kangaroo", emoji: "\uD83E\uDD98", imageBase: "kangaroo", weightClass: "heavyweight",
        stats: { strength: 70, speed: 75, defense: 58, aggression: 82 } },
      { id: "leopard_seal_001", name: "Leopard Seal", emoji: "\uD83E\uDDAD", imageBase: "leopard-seal", weightClass: "heavyweight",
        stats: { strength: 76, speed: 70, defense: 68, aggression: 86 } },
      { id: "walrus_001", name: "Walrus", emoji: "\uD83E\uDDAD", imageBase: "walrus", weightClass: "heavyweight",
        stats: { strength: 85, speed: 35, defense: 90, aggression: 65 } },
      { id: "ostrich_001", name: "Ostrich", emoji: "\uD83D\uDC26", imageBase: "ostrich", weightClass: "heavyweight",
        stats: { strength: 60, speed: 90, defense: 50, aggression: 68 } },
    ];
    animals.forEach(function(a) {
      a.fightScore = a.stats.strength + a.stats.speed + a.stats.defense + a.stats.aggression;
    });

    // ==================== TOURNAMENT LOGIC ====================
    function shuffleArray(arr) {
      var a = arr.slice();
      for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
      }
      return a;
    }

    function generateTournamentMatchups() {
      var pairings = [];
      for (var i = 0; i < animals.length; i++) {
        for (var j = i + 1; j < animals.length; j++) {
          pairings.push({ left: animals[i], right: animals[j] });
        }
      }
      var shuffled = shuffleArray(pairings);
      return shuffled.slice(0, TOURNAMENT_ROUNDS).map(function(pair) {
        if (Math.random() < 0.5) return { left: pair.right, right: pair.left };
        return pair;
      });
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    function determineWinner(a1, a2) {
      var s1 = Math.round(a1.fightScore * (0.9 + Math.random() * 0.2));
      var s2 = Math.round(a2.fightScore * (0.9 + Math.random() * 0.2));
      return { winner: s1 > s2 ? a1 : a2, scores: { left: s1, right: s2 } };
    }

    // ==================== STORAGE ====================
    function loadLeaderboard() {
      try { var d = localStorage.getItem("af_leaderboard"); return d ? JSON.parse(d) : []; } catch(ex) { return []; }
    }
    function saveLeaderboard(entries) {
      try { localStorage.setItem("af_leaderboard", JSON.stringify(entries)); } catch(ex) {}
    }
    function loadSession() {
      try { var d = localStorage.getItem("af_session"); return d ? JSON.parse(d) : null; } catch(ex) { return null; }
    }
    function saveSession(session) {
      try { localStorage.setItem("af_session", JSON.stringify(session)); } catch(ex) {}
    }
    function updateLocalLeaderboard(name, score) {
      var entries = loadLeaderboard();
      var existing = entries.find(function(x) { return x.name === name; });
      if (existing) {
        if (score > existing.score) { existing.score = score; existing.timestamp = Date.now(); }
      } else {
        entries.push({ name: name, score: score, timestamp: Date.now() });
      }
      entries.sort(function(a, b) { return b.score - a.score || a.timestamp - b.timestamp; });
      saveLeaderboard(entries.slice(0, 20));
    }

    // ==================== COMPONENTS ====================

    function AnimalAvatar(props) {
      var animal = props.animal, size = props.size || "normal";
      var extensions = ["jpg", "jpeg", "png", "webp"];
      var ref = useState(0), extIndex = ref[0], setExtIndex = ref[1];
      var ref2 = useState(false), allFailed = ref2[0], setAllFailed = ref2[1];
      var sizeClass = size === "large" ? "w-28 h-28 sm:w-36 sm:h-36" : "w-20 h-20 sm:w-28 sm:h-28";
      var emojiSize = size === "large" ? "text-7xl sm:text-8xl" : "text-5xl sm:text-6xl";
      if (allFailed || !animal.imageBase) {
        return e("span", { className: emojiSize + " leading-none select-none" }, animal.emoji);
      }
      return e("img", {
        src: "images/" + animal.imageBase + "." + extensions[extIndex],
        alt: animal.name,
        className: sizeClass + " object-cover rounded-full border-2 border-white/20",
        onError: function() {
          if (extIndex < extensions.length - 1) setExtIndex(function(i) { return i + 1; });
          else setAllFailed(true);
        }
      });
    }

    function LightningBolt(props) {
      if (!props.visible) return null;
      return e("div", { className: "absolute inset-0 flex items-center justify-center z-20 pointer-events-none lightning-flash" },
        e("svg", { width: "80", height: "120", viewBox: "0 0 80 120", fill: "none" },
          e("defs", null,
            e("linearGradient", { id: "boltGrad", x1: "0%", y1: "0%", x2: "0%", y2: "100%" },
              e("stop", { offset: "0%", stopColor: "#FFD700" }),
              e("stop", { offset: "100%", stopColor: "#FF8C00" })
            )
          ),
          e("polygon", { points: "45,0 15,55 35,55 20,120 65,50 42,50 58,0", fill: "url(#boltGrad)", stroke: "#FFA500", strokeWidth: "2" })
        ),
        e("div", { className: "absolute inset-0 bg-yellow-400/10 rounded-3xl" })
      );
    }

    function StatBar(props) {
      var label = props.label, v1 = props.value1, v2 = props.value2, delay = props.delay, show = props.showResult;
      var c1 = v1 >= v2 ? "bg-green-400" : "bg-red-400";
      var c2 = v2 >= v1 ? "bg-green-400" : "bg-red-400";
      return e("div", { className: "mb-3" },
        e("div", { className: "text-xs text-gray-400 text-center mb-1 uppercase tracking-wider font-semibold" }, label),
        e("div", { className: "flex items-center gap-2" },
          e("div", { className: "flex-1 flex justify-end" },
            e("div", { className: "w-full bg-gray-800 rounded-full h-4 overflow-hidden" },
              e("div", { className: "h-full rounded-full " + c1 + (show ? " stat-bar-animate stat-bar-delay-" + delay : ""), style: { width: show ? v1 + "%" : "0%", float: "right" } })
            )
          ),
          e("div", { className: "w-14 text-center text-xs font-bold" },
            e("span", { className: v1 >= v2 ? "text-green-400" : "text-red-400" }, v1),
            e("span", { className: "text-gray-500" }, " : "),
            e("span", { className: v2 >= v1 ? "text-green-400" : "text-red-400" }, v2)
          ),
          e("div", { className: "flex-1" },
            e("div", { className: "w-full bg-gray-800 rounded-full h-4 overflow-hidden" },
              e("div", { className: "h-full rounded-full " + c2 + (show ? " stat-bar-animate stat-bar-delay-" + delay : ""), style: { width: show ? v2 + "%" : "0%" } })
            )
          )
        )
      );
    }

    function Header(props) {
      return e("div", null,
        e("div", { className: "bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 px-4 py-3 border-b border-gray-700/50" },
          e("div", { className: "max-w-lg mx-auto flex items-center justify-between" },
            e("div", null,
              e("h1", { className: "text-lg font-black tracking-tight" },
                e("span", { className: "text-orange-400" }, "ANIMAL"),
                e("span", { className: "text-white" }, " FACEOFF")
              )
            ),
            e("div", { className: "flex items-center gap-4 text-sm" },
              props.streak >= 3 ? e("span", { className: "streak-fire font-bold text-orange-400" }, "\uD83D\uDD25" + props.streak) : null,
              e("div", { className: "text-center" },
                e("div", { className: "text-gray-400 text-xs" }, "SCORE"),
                e("div", { className: "font-bold text-orange-400" }, props.score)
              ),
              e("div", { className: "text-center" },
                e("div", { className: "text-gray-400 text-xs" }, "ROUND"),
                e("div", { className: "font-bold" }, props.round + "/" + TOURNAMENT_ROUNDS)
              ),
              e("button", { onClick: props.onLeaderboard, className: "p-2 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 active:scale-95 transition-all" }, "\uD83C\uDFC6")
            )
          )
        ),
        // Progress bar
        e("div", { className: "w-full h-1 bg-gray-800" },
          e("div", { className: "h-full bg-gradient-to-r from-orange-500 to-orange-400 transition-all duration-500", style: { width: (props.round / TOURNAMENT_ROUNDS * 100) + "%" } })
        )
      );
    }

    function AnimalCard(props) {
      var animal = props.animal, side = props.side, disabled = props.disabled, result = props.result, isWinner = props.isWinner, isLoser = props.isLoser;
      var cardClass = "animal-card relative flex flex-col items-center pt-8 sm:pt-10 p-4 sm:p-6 rounded-2xl ";
      var animClass = side === "left" ? "slide-in-left" : "slide-in-right";
      if (result) {
        if (isWinner) cardClass += "bg-gradient-to-b from-green-900/60 to-green-800/30 border-2 border-green-400/60 pulse-win ";
        else if (isLoser) cardClass += "bg-gradient-to-b from-gray-900/80 to-gray-800/40 border-2 border-gray-600/30 opacity-50 grayscale ";
      } else {
        cardClass += "bg-gradient-to-b from-gray-800/80 to-gray-700/40 border-2 border-gray-600/30 hover:border-orange-400/50 glow-pulse ";
      }
      return e("button", {
        onClick: function() { if (!disabled) props.onSelect(animal); },
        disabled: disabled,
        className: cardClass + " " + animClass + " flex-1 min-h-[220px] sm:min-h-[280px]"
      },
        isWinner && result ? e("div", { className: "absolute -top-3 left-1/2 -translate-x-1/2 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10" }, "WINNER!") : null,
        e("div", { className: "mb-3" }, e(AnimalAvatar, { animal: animal, size: "large" })),
        e("div", { className: "text-lg sm:text-xl font-bold text-center" }, animal.name),
        e("div", { className: "text-xs text-gray-400 mt-1 uppercase tracking-wider" }, animal.weightClass),
        !result && !disabled ? e("div", { className: "mt-3 text-xs text-orange-400/80 font-medium" }, "TAP TO SELECT") : null
      );
    }

    function ResultModal(props) {
      if (!props.matchup || !props.winner) return null;
      var left = props.matchup.left, right = props.matchup.right;
      var isCorrect = props.isCorrect;
      var isFinalRound = props.round >= TOURNAMENT_ROUNDS;
      var fs = props.fightScores || { left: left.fightScore, right: right.fightScore };
      var leftWon = props.winner.id === left.id;
      return e("div", { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-end sm:items-center justify-center z-30 p-4 fade-in" },
        e("div", { className: "bg-gray-900 rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl fade-in-up max-h-[85vh] overflow-y-auto" },
          e("div", { className: "p-5 text-center rounded-t-2xl " + (isCorrect ? "bg-gradient-to-b from-green-900/50 to-transparent" : "bg-gradient-to-b from-red-900/50 to-transparent") },
            e("div", { className: "text-4xl mb-2" }, isCorrect ? "\uD83C\uDF89" : "\uD83D\uDE14"),
            e("div", { className: "text-xl font-black " + (isCorrect ? "text-green-400" : "text-red-400") }, isCorrect ? "CORRECT!" : "WRONG!"),
            e("div", { className: "text-gray-400 text-sm mt-1" }, props.winner.name + " wins this round!"),
            isCorrect && props.streak >= 3 ? e("div", { className: "mt-2 text-orange-400 font-bold streak-fire" }, "\uD83D\uDD25 " + props.streak + " streak! +" + props.points + " pts") : null
          ),
          e("div", { className: "px-5 py-4" },
            e("div", { className: "flex items-center justify-evenly mb-4" },
              e("div", { className: "text-center" },
                e("div", { className: "flex justify-center" }, e(AnimalAvatar, { animal: left })),
                e("div", { className: "text-sm font-bold mt-1" }, left.name),
                e("div", { className: "text-xs font-bold mt-1 " + (leftWon ? "text-green-400" : "text-red-400") }, "Fight: " + fs.left)
              ),
              e("div", { className: "text-gray-500 text-xs font-bold px-2" }, "VS"),
              e("div", { className: "text-center" },
                e("div", { className: "flex justify-center" }, e(AnimalAvatar, { animal: right })),
                e("div", { className: "text-sm font-bold mt-1" }, right.name),
                e("div", { className: "text-xs font-bold mt-1 " + (!leftWon ? "text-green-400" : "text-red-400") }, "Fight: " + fs.right)
              )
            ),
            e(StatBar, { label: "Strength", value1: left.stats.strength, value2: right.stats.strength, delay: 1, showResult: true }),
            e(StatBar, { label: "Speed", value1: left.stats.speed, value2: right.stats.speed, delay: 2, showResult: true }),
            e(StatBar, { label: "Defense", value1: left.stats.defense, value2: right.stats.defense, delay: 3, showResult: true }),
            e(StatBar, { label: "Aggression", value1: left.stats.aggression, value2: right.stats.aggression, delay: 4, showResult: true })
          ),
          e("div", { className: "px-5 pb-5" },
            e("button", { onClick: props.onNext, className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform shadow-lg shadow-orange-500/20" },
              isFinalRound ? "FINISH TOURNAMENT \uD83C\uDFC6" : "NEXT ROUND \u27A1\uFE0F"
            )
          )
        )
      );
    }

    function LeaderboardModal(props) {
      var entries = props.entries, userName = props.userName, isGlobal = props.source === "global";
      var userRank = entries.findIndex(function(x) { return x.name === userName; }) + 1;
      var medals = ["\uD83E\uDD47", "\uD83E\uDD48", "\uD83E\uDD49"];
      return e("div", { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-end sm:items-center justify-center z-30 p-4 fade-in" },
        e("div", { className: "bg-gray-900 rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl fade-in-up max-h-[80vh] overflow-y-auto" },
          e("div", { className: "p-5 text-center border-b border-gray-700/50" },
            e("div", { className: "text-3xl mb-2" }, "\uD83C\uDFC6"),
            e("h2", { className: "text-xl font-black" }, "LEADERBOARD"),
            e("div", { className: "inline-block mt-2 px-3 py-1 rounded-full text-xs font-bold " + (isGlobal ? "bg-green-500/20 text-green-400" : "bg-gray-700 text-gray-400") },
              isGlobal ? "\uD83C\uDF10 GLOBAL" : "\uD83D\uDCF1 THIS DEVICE"
            ),
            userRank > 0 ? e("div", { className: "text-sm text-gray-400 mt-1" }, "Your rank: #" + userRank) : null
          ),
          e("div", { className: "p-4" },
            entries.length === 0 ?
              e("div", { className: "text-center text-gray-500 py-8" },
                e("div", { className: "text-4xl mb-3" }, "\uD83C\uDFAE"),
                e("div", null, "No scores yet!"),
                e("div", { className: "text-sm mt-1" }, "Complete a tournament to get on the board")
              ) :
              e("div", { className: "space-y-2" },
                entries.map(function(entry, i) {
                  var isUser = entry.name === userName;
                  return e("div", {
                    key: i,
                    className: "flex items-center justify-between p-3 rounded-xl " + (isUser ? "bg-orange-500/10 border border-orange-500/30" : "bg-gray-800/50")
                  },
                    e("div", { className: "flex items-center gap-3" },
                      e("span", { className: "text-lg w-8 text-center" },
                        i < 3 ? medals[i] : e("span", { className: "text-gray-500 text-sm font-bold" }, "#" + (i + 1))
                      ),
                      e("div", null,
                        e("span", { className: "font-semibold " + (isUser ? "text-orange-400" : "") }, entry.name + (isUser ? " (you)" : "")),
                        entry.roundsCorrect != null ? e("div", { className: "text-xs text-gray-500" }, entry.roundsCorrect + "/" + TOURNAMENT_ROUNDS + " correct") : null
                      )
                    ),
                    e("span", { className: "font-bold text-lg" }, entry.score)
                  );
                })
              )
          ),
          e("div", { className: "px-5 pb-5" },
            e("button", { onClick: props.onClose, className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all" }, "BACK TO GAME")
          )
        )
      );
    }

    function NameEntry(props) {
      var ref = useState(""), name = ref[0], setName = ref[1];
      var inputRef = useRef(null);
      useEffect(function() { setTimeout(function() { if (inputRef.current) inputRef.current.focus(); }, 300); }, []);
      function handleSubmit(ev) {
        ev.preventDefault();
        var trimmed = name.trim();
        if (trimmed.length >= 1 && trimmed.length <= 20) props.onSubmit(trimmed);
      }
      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm" },
          e("div", { className: "text-6xl mb-4" }, "\uD83E\uDD81"),
          e("h1", { className: "text-3xl font-black mb-2" },
            e("span", { className: "text-orange-400" }, "ANIMAL"),
            e("span", { className: "text-white" }, " FACEOFF")
          ),
          e("p", { className: "text-gray-400 mb-8" }, "Predict the winner of epic animal battles!"),
          e("form", { onSubmit: handleSubmit, className: "space-y-4" },
            e("div", null,
              e("label", { className: "text-sm text-gray-400 block mb-2" }, "What's your name?"),
              e("input", {
                ref: inputRef, type: "text", value: name,
                onChange: function(ev) { setName(ev.target.value); },
                placeholder: "Enter your name...", maxLength: 20,
                className: "w-full px-4 py-4 bg-gray-800 border-2 border-gray-600 rounded-xl text-white text-center text-lg font-semibold focus:border-orange-400 focus:outline-none transition-colors placeholder-gray-500"
              })
            ),
            e("button", {
              type: "submit", disabled: name.trim().length < 1,
              className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg disabled:opacity-30 disabled:cursor-not-allowed active:scale-95 transition-all shadow-lg shadow-orange-500/20"
            }, "LET'S GO! \uD83D\uDD25")
          )
        )
      );
    }

    function TournamentReady(props) {
      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm" },
          e("div", { className: "text-6xl mb-4" }, "\u2694\uFE0F"),
          e("h1", { className: "text-3xl font-black mb-2" },
            e("span", { className: "text-orange-400" }, "TOURNAMENT"),
            e("span", { className: "text-white" }, " MODE")
          ),
          e("p", { className: "text-gray-400 mb-2" },
            "Welcome, " + props.playerName + "! ",
            e("button", { onClick: props.onChangeName, className: "text-orange-400 underline text-sm" }, "Not you?")
          ),
          e("p", { className: "text-gray-500 text-sm mb-8" }, TOURNAMENT_ROUNDS + " rounds \u2022 No repeated matchups \u2022 Best score wins"),
          e("div", { className: "space-y-3" },
            e("button", {
              onClick: props.onStart,
              className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-all shadow-lg shadow-orange-500/20"
            }, "START TOURNAMENT \u2694\uFE0F"),
            e("button", {
              onClick: props.onLeaderboard,
              className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all"
            }, "VIEW LEADERBOARD \uD83C\uDFC6")
          )
        )
      );
    }

    function TournamentEnd(props) {
      var pct = Math.round((props.roundsCorrect / TOURNAMENT_ROUNDS) * 100);
      var grade;
      if (pct >= 90) grade = { label: "LEGENDARY", color: "text-yellow-400", emoji: "\uD83C\uDFC6" };
      else if (pct >= 70) grade = { label: "EXCELLENT", color: "text-green-400", emoji: "\uD83C\uDF1F" };
      else if (pct >= 50) grade = { label: "GOOD", color: "text-blue-400", emoji: "\uD83D\uDC4D" };
      else grade = { label: "KEEP TRYING", color: "text-gray-400", emoji: "\uD83D\uDCAA" };

      return e("div", { className: "fixed inset-0 bg-gradient-to-b from-gray-900 to-gray-950 flex items-center justify-center z-40 p-6" },
        e("div", { className: "text-center fade-in-up w-full max-w-sm" },
          e("div", { className: "text-6xl mb-4" }, grade.emoji),
          e("h1", { className: "text-2xl font-black mb-1 " + grade.color }, grade.label),
          e("p", { className: "text-gray-400 mb-6" }, "Tournament Complete!"),
          e("div", { className: "grid grid-cols-2 gap-3 mb-6" },
            e("div", { className: "bg-gray-800/60 rounded-xl p-4" },
              e("div", { className: "text-2xl font-black text-orange-400" }, props.score),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Final Score")
            ),
            e("div", { className: "bg-gray-800/60 rounded-xl p-4" },
              e("div", { className: "text-2xl font-black text-green-400" }, props.roundsCorrect + "/" + TOURNAMENT_ROUNDS),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Correct")
            ),
            e("div", { className: "bg-gray-800/60 rounded-xl p-4" },
              e("div", { className: "text-2xl font-black text-orange-400" }, props.bestStreak),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Best Streak")
            ),
            e("div", { className: "bg-gray-800/60 rounded-xl p-4" },
              e("div", { className: "text-2xl font-black text-blue-400" }, pct + "%"),
              e("div", { className: "text-xs text-gray-400 uppercase" }, "Accuracy")
            )
          ),
          e("div", { className: "space-y-3" },
            e("button", {
              onClick: props.onPlayAgain,
              className: "w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-all shadow-lg shadow-orange-500/20"
            }, "PLAY AGAIN \uD83D\uDD01"),
            e("button", {
              onClick: props.onLeaderboard,
              className: "w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl active:scale-95 transition-all"
            }, "LEADERBOARD \uD83C\uDFC6")
          )
        )
      );
    }

    // ==================== MAIN GAME ====================
    function AnimalFaceoffGame() {
      var gsRef = useState("loading"), gameState = gsRef[0], setGameState = gsRef[1];
      var muRef = useState(null), currentMatchup = muRef[0], setCurrentMatchup = muRef[1];
      var saRef = useState(null), selectedAnimal = saRef[0], setSelectedAnimal = saRef[1];
      var wRef = useState(null), winner = wRef[0], setWinner = wRef[1];
      var scRef = useState(0), score = scRef[0], setScore = scRef[1];
      var rdRef = useState(1), round = rdRef[0], setRound = rdRef[1];
      var stRef = useState(0), streak = stRef[0], setStreak = stRef[1];
      var unRef = useState(""), userName = unRef[0], setUserName = unRef[1];
      var lbRef = useState([]), leaderboard = lbRef[0], setLeaderboard = lbRef[1];
      var slRef = useState(false), showLightning = slRef[0], setShowLightning = slRef[1];
      var lpRef = useState(0), lastPoints = lpRef[0], setLastPoints = lpRef[1];
      var akRef = useState(0), animKey = akRef[0], setAnimKey = akRef[1];
      // Tournament state
      var tmRef = useState([]), tournamentMatchups = tmRef[0], setTournamentMatchups = tmRef[1];
      var tiRef = useState(null), tournamentId = tiRef[0], setTournamentId = tiRef[1];
      var rcRef = useState(0), roundsCorrect = rcRef[0], setRoundsCorrect = rcRef[1];
      var bsRef = useState(0), bestStreak = bsRef[0], setBestStreak = bsRef[1];
      var lsRef = useState("local"), leaderboardSource = lsRef[0], setLeaderboardSource = lsRef[1];
      var fsRef = useState(null), fightScores = fsRef[0], setFightScores = fsRef[1];
      var prevGameStateRef = useRef("loading");

      // Initialize
      useEffect(function() {
        var session = loadSession();
        if (session && session.name) {
          setUserName(session.name);
          if (session.tournamentMatchups && session.tournamentMatchups.length > 0 && session.gameState === "playing") {
            setTournamentMatchups(session.tournamentMatchups);
            setTournamentId(session.tournamentId);
            setScore(session.score || 0);
            setRound(session.round || 1);
            setStreak(session.streak || 0);
            setRoundsCorrect(session.roundsCorrect || 0);
            setBestStreak(session.bestStreak || 0);
            setCurrentMatchup(session.tournamentMatchups[(session.round || 1) - 1]);
            setAnimKey(function(k) { return k + 1; });
            setGameState("playing");
          } else {
            setGameState("tournament_ready");
          }
        } else {
          setGameState("name_entry");
        }
        setLeaderboard(loadLeaderboard());
      }, []);

      // Save session when playing
      useEffect(function() {
        if (userName && gameState === "playing" && tournamentMatchups.length > 0) {
          saveSession({
            name: userName, score: score, round: round, streak: streak,
            roundsCorrect: roundsCorrect, bestStreak: bestStreak,
            tournamentMatchups: tournamentMatchups, tournamentId: tournamentId,
            gameState: "playing"
          });
        }
      }, [score, round, streak, userName, roundsCorrect, bestStreak, tournamentMatchups, tournamentId, gameState]);

      function handleNameSubmit(name) {
        setUserName(name);
        saveSession({ name: name });
        setGameState("tournament_ready");
      }

      function handleStartTournament() {
        var matchups = generateTournamentMatchups();
        var tid = generateUUID();
        setTournamentMatchups(matchups);
        setTournamentId(tid);
        setScore(0);
        setRound(1);
        setStreak(0);
        setRoundsCorrect(0);
        setBestStreak(0);
        setCurrentMatchup(matchups[0]);
        setSelectedAnimal(null);
        setWinner(null);
        setShowLightning(false);
        setAnimKey(function(k) { return k + 1; });
        setGameState("playing");
      }

      function handleAnimalSelect(animal) {
        if (gameState !== "playing" || !currentMatchup) return;
        setSelectedAnimal(animal);
        setShowLightning(true);
        setGameState("selected");
        var result = determineWinner(currentMatchup.left, currentMatchup.right);
        setWinner(result.winner);
        setFightScores(result.scores);
        var isCorrect = animal.id === result.winner.id;
        var newStreak = isCorrect ? streak + 1 : 0;
        var streakBonus = isCorrect && newStreak > 0 && newStreak % 5 === 0 ? 5 : 0;
        var points = isCorrect ? 10 + streakBonus : 0;
        setStreak(newStreak);
        setLastPoints(points);
        setScore(function(s) { return s + points; });
        if (isCorrect) setRoundsCorrect(function(rc) { return rc + 1; });
        setBestStreak(function(prev) { return Math.max(prev, newStreak); });
        setTimeout(function() { setShowLightning(false); setGameState("result"); }, 500);
      }

      function handleNextRound() {
        var nextRound = round + 1;
        if (nextRound > TOURNAMENT_ROUNDS) {
          // Tournament over
          updateLocalLeaderboard(userName, score);
          setLeaderboard(loadLeaderboard());
          submitScoreToSupabase({
            player_name: userName,
            score: score,
            streak: bestStreak,
            rounds_correct: roundsCorrect,
            tournament_id: tournamentId
          });
          saveSession({ name: userName });
          setGameState("tournament_end");
        } else {
          setRound(nextRound);
          setCurrentMatchup(tournamentMatchups[nextRound - 1]);
          setSelectedAnimal(null);
          setWinner(null);
          setShowLightning(false);
          setAnimKey(function(k) { return k + 1; });
          setGameState("playing");
        }
      }

      function handlePlayAgain() {
        saveSession({ name: userName });
        setGameState("tournament_ready");
      }

      function handleShowLeaderboard() {
        prevGameStateRef.current = gameState;
        updateLocalLeaderboard(userName, score);
        setLeaderboard(loadLeaderboard());
        setLeaderboardSource("local");
        setGameState("leaderboard");
        fetchGlobalLeaderboard().then(function(data) {
          if (data && data.length > 0) {
            var formatted = data.map(function(row) {
              return { name: row.player_name, score: row.score, streak: row.streak, roundsCorrect: row.rounds_correct };
            });
            setLeaderboard(formatted);
            setLeaderboardSource("global");
          }
        });
      }

      function handleCloseLeaderboard() {
        var prev = prevGameStateRef.current;
        if (prev === "playing" || prev === "selected" || prev === "result") {
          setGameState("playing");
        } else if (prev === "tournament_end") {
          setGameState("tournament_end");
        } else {
          setGameState("tournament_ready");
        }
      }

      // Loading
      if (gameState === "loading") {
        return e("div", { className: "min-h-screen flex items-center justify-center" },
          e("div", { className: "text-2xl font-bold text-orange-400 animate-pulse" }, "Loading...")
        );
      }

      // Name entry
      if (gameState === "name_entry") return e(NameEntry, { onSubmit: handleNameSubmit });

      // Tournament ready
      if (gameState === "tournament_ready") {
        return e("div", null,
          e(TournamentReady, { playerName: userName, onStart: handleStartTournament, onLeaderboard: handleShowLeaderboard, onChangeName: function() { setUserName(""); saveSession({}); setGameState("name_entry"); } }),
          gameState === "leaderboard" ? e(LeaderboardModal, { entries: leaderboard, userName: userName, source: leaderboardSource, onClose: handleCloseLeaderboard }) : null
        );
      }

      // Tournament end
      if (gameState === "tournament_end") {
        return e(TournamentEnd, {
          score: score, roundsCorrect: roundsCorrect, bestStreak: bestStreak,
          onPlayAgain: handlePlayAgain, onLeaderboard: handleShowLeaderboard
        });
      }

      // Leaderboard (standalone, from tournament_ready or tournament_end)
      if (gameState === "leaderboard") {
        return e(LeaderboardModal, { entries: leaderboard, userName: userName, source: leaderboardSource, onClose: handleCloseLeaderboard });
      }

      var isCorrect = selectedAnimal && winner && selectedAnimal.id === winner.id;

      // Main game (playing / selected / result)
      return e("div", { className: "min-h-screen flex flex-col bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950" },
        e(Header, { score: score, round: round, streak: streak, onLeaderboard: handleShowLeaderboard }),
        e("div", { className: "flex-1 flex flex-col items-center justify-center p-4 sm:p-6" },
          e("div", { className: "w-full max-w-lg" },
            e("div", { className: "text-center mb-4 fade-in" },
              e("div", { className: "text-sm text-gray-400 uppercase tracking-widest font-semibold" }, "Who Would Win?")
            ),
            currentMatchup ? e("div", { className: "relative flex items-start gap-0", key: animKey },
              e(AnimalCard, { animal: currentMatchup.left, onSelect: handleAnimalSelect, side: "left", disabled: gameState !== "playing", result: gameState === "result", isWinner: gameState === "result" && winner && winner.id === currentMatchup.left.id, isLoser: gameState === "result" && winner && winner.id !== currentMatchup.left.id }),
              e("div", { className: "flex-shrink-0 z-10 vs-pop -mx-5", style: { marginTop: "calc(2rem + 2rem)" } },
                e("div", { className: "w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/30 border-2 border-orange-300/30" },
                  e("span", { className: "text-white font-black text-sm sm:text-base" }, "VS")
                )
              ),
              e(LightningBolt, { visible: showLightning }),
              e(AnimalCard, { animal: currentMatchup.right, onSelect: handleAnimalSelect, side: "right", disabled: gameState !== "playing", result: gameState === "result", isWinner: gameState === "result" && winner && winner.id === currentMatchup.right.id, isLoser: gameState === "result" && winner && winner.id !== currentMatchup.right.id })
            ) : null,
            streak >= 3 && gameState === "playing" ? e("div", { className: "text-center mt-4 fade-in" },
              e("span", { className: "text-orange-400 font-bold streak-fire text-sm" }, "\uD83D\uDD25 " + streak + " correct in a row!")
            ) : null
          )
        ),
        e("div", { className: "text-center py-3 text-gray-600 text-xs" }, "Heavyweight Division \u2022 Tournament Mode"),
        gameState === "result" ? e(ResultModal, { matchup: currentMatchup, winner: winner, selectedAnimal: selectedAnimal, points: lastPoints, isCorrect: isCorrect, streak: streak, round: round, fightScores: fightScores, onNext: handleNextRound }) : null
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(e(AnimalFaceoffGame));
  </script>
</body>
</html>
